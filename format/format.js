window.storyFormat({
	name: "Harrow",
	version: "1.2.0",
	description: "Harrow narrative format. See its <a href='https://github.com/nayata/harrow' target='_blank'>documentation</a>.",
	author: "Nayata",
	proofing: false,
	source: "<!DOCTYPE html>\r\n<html>\r\n\t<head>\r\n\t\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\r\n\t\t<meta charset=\"utf-8\"/>\r\n\t\t<title>{{STORY_NAME}}</title>\r\n\t\t<style>html {\r\n\tdisplay: grid;\r\n\theight: 100%;\r\n\tfont-size: 100%;\r\n\tfont-size: 21px;\r\n}\r\n\r\nbody {\r\n\tfont-family: 'Helvetica', sans-serif;\r\n\tbackground: #222222;\r\n\tbackground-image: none;\r\n\tbackground-position: 50% 50%;\r\n\tbackground-repeat: no-repeat;\r\n\tbackground-size: cover;\r\n\tscroll-behavior: smooth;\r\n\toverflow: auto;\r\n}\r\n\r\n/* Page Layout */\r\npage {\r\n\tmin-width: 0;\r\n\tmin-height: 0;\r\n\twidth: 700px;\r\n\theight: 90%;\r\n\tdisplay: grid;\r\n\tgrid-template-rows: auto 1fr auto;\r\n\tposition: absolute;\r\n\ttop: 0; bottom: 0; left: 0; right: 0;\r\n\tmargin: auto;\r\n\tborder-radius: 16px;\r\n\tfont-size: 1rem;\r\n\tcolor: #333;\r\n\tbackground: #fafafa;\r\n\ttransition: 0.6s background ease;\r\n}\r\n\r\n/* Page Layout with Illustration */\r\npage.novel {\r\n\tgrid-template-rows: auto auto 1fr auto;\r\n}\r\npage.novel textbox {\r\n\tpadding: 1em 3em 0;\r\n}\r\n\r\n/* Page Elements */\r\nheader {\r\n\tpadding: 2em 3em 1em;\r\n\tcolor: #555;\r\n}\r\nchapter {\r\n\tfloat: left;\r\n}\r\n\r\nimagebox {\r\n\tdisplay: none;\r\n\tposition: relative;\r\n\tpadding: 0 3em;\r\n\tmargin: 0 3em;\r\n\twidth: auto;\r\n\theight: 280px;\r\n\tbackground: #fff;\r\n\tbackground-image: none;\r\n\tbackground-position: 50% 50%;\r\n\tbackground-size: cover;\r\n\topacity: 0;\r\n}\r\n\r\ntextbox {\r\n\tpadding: 2em 3em 0;\r\n\tscroll-behavior: smooth;\r\n\toverflow: auto;\r\n\twidth: auto;\r\n}\r\ntextbox p {\r\n\tline-height: 1.5;\r\n\tmargin-top: 1rem;\r\n}\r\ntextbox img {\r\n\twidth: 100%;\r\n\theight: auto;\r\n}\r\n.speaker {\r\n\tdisplay: none;\r\n}\r\n\r\naction {\r\n\tpadding: 0 3em 2em;\r\n}\r\n\r\nchoice, button {\r\n\tpadding: 16px 0;\r\n\tborder-style: none;\r\n\tborder-radius: 10px;\r\n\tfont-family: sans-serif;\r\n\tfont-weight: 500;\r\n\tfont-style: normal;\r\n\tfont-size: .875em;\r\n\tline-height: 1.5;\r\n\tcolor: #ececec;\r\n\tbackground-color: rgb(50, 50, 50);\r\n\tcursor: pointer;\r\n\tdisplay: block;\r\n\tmargin: 4px auto 0;\r\n\ttext-align: center;\r\n\twidth: 70%;\r\n}\r\nbutton:hover {\r\n\tbackground-color: rgb(46, 46, 46);\r\n}\r\n.disabled {\r\n\tpointer-events: none;\r\n\topacity: 0.9;\r\n}\r\n\r\n/* Settings buttons */\r\nopen, close {\r\n\tdisplay: block;\r\n\tposition: absolute;\r\n\ttop: 2em; right: 3em;\r\n\tcursor: pointer;\r\n\theight: 20px;\r\n\twidth: 20px;\r\n}\r\nopen {\r\n\tbackground-image: url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' version='1.1' x='0px' y='0px' fill='currentColor' width='30px' height='30px' viewBox='0 0 30 30' enable-background='new 0 0 30 30' xml:space='preserve'><rect width='30' height='6'/><rect y='24' width='30' height='6'/><rect y='12' width='30' height='6'/></svg>\");\r\n\tbackground-size: contain;\r\n\topacity: 0.75;\r\n}\r\nclose {\r\n\tbackground-image: url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' version='1.1' x='0px' y='0px' fill='currentColor' stroke='currentColor' stroke-width='7' width='30px' height='30px' viewBox='0 0 30 30' enable-background='new 0 0 30 30' xml:space='preserve'><line x1='2' y1='2' x2='28' y2='28'/><line x1='28' x2='2' y1='2' y2='28'/></svg>\");\r\n\tbackground-size: contain;\r\n\topacity: 0.75;\r\n\tz-index: -100;\r\n}\r\n\r\n/* Settings screen */\r\nsettings {\r\n\twidth: auto;\r\n\theight: auto;\r\n\tdisplay: none;\r\n\tposition: absolute;\r\n\ttop: 0; bottom: 0; left: 0; right: 0;\r\n\tpadding: 6em 0 2em;\r\n\tmargin: auto;\r\n\tborder-radius: 16px;\r\n\tbackground: #fafafa;\r\n\toverflow: auto;\r\n\tfont-size: 1rem;\r\n\tz-index: -1;\r\n\topacity: 0;\r\n}\r\nsettings content {\r\n\tpadding: 0 3em;\r\n\tscroll-behavior: smooth;\r\n\toverflow: auto;\r\n}\r\nsettings p {\r\n\tline-height: 1.5;\r\n\tmargin-top: 1rem;\r\n}\r\nsettings img {\r\n\twidth: 100%;\r\n\theight: auto;\r\n}\r\n\r\n/* Resize */\r\n@media screen and (max-width: 600px) {\r\n\tpage {\r\n\t\twidth: 100%;\r\n\t\theight: 100%;\r\n\t\tborder-radius: 0;\r\n\t}\r\n\theader {\r\n\t\tpadding: 2em 2em 1em;\r\n\t}\r\n\timagebox {\r\n\t\tmargin: 0 2em;\r\n\t}\r\n\ttextbox {\r\n\t\tpadding: 2em 2em 0;\r\n\t}\r\n\taction {\r\n\t\tpadding: 0 2em 2em;\r\n\t}\r\n\tchoice, button {\r\n\t\twidth: 100%;\r\n\t}\r\n\tpage.novel textbox {\r\n\t\tpadding: 1em 2em 0;\r\n\t}\r\n\topen, close {\r\n\t\tright: 2em;\r\n\t}\r\n\tsettings {\r\n\t\tborder-radius: 0;\r\n\t}\r\n\tsettings content {\r\n\t\tpadding: 0 2em;\r\n\t}\r\n}</style>\r\n\t</head>\r\n\t<body>\r\n\t\t{{STORY_DATA}}\r\n\t\t<transition></transition>\r\n\t\t<page>\r\n\t\t<settings></settings>\r\n\t\t<close></close><open></open>\r\n\t\t<header>\r\n\t\t\t<chapter>Chapter</chapter>\r\n\t\t</header>\r\n\t\t<imagebox></imagebox>\r\n\t\t<textbox></textbox>\r\n\t\t<action>\r\n\t\t\t<dialogue></dialogue>\r\n\t\t\t<button></button>\r\n\t\t</action>\r\n\t\t</page>\r\n\t</body>\r\n\t<script src=\"https://code.jquery.com/jquery-3.1.0.min.js\"></script>\r\n\t<script>\r\n\t\t// Generated by Haxe 4.3.4\n(function ($hx_exports, $global) { \"use strict\";\nfunction $extend(from, fields) {\n\tvar proto = Object.create(from);\n\tfor (var name in fields) proto[name] = fields[name];\n\tif( fields.toString !== Object.prototype.toString ) proto.toString = fields.toString;\n\treturn proto;\n}\nvar App = $hx_exports[\"App\"] = function() {\n\tthis.folder = \"\";\n\tthis.buffer = \"\";\n\tthis.maxlenght = 240;\n\tthis.parsespeaker = false;\n\tthis.bookmark = [];\n\tvar _gthis = this;\n\tvar dice = new Dice();\n\tharrow_Random.dice = $bind(dice,dice.roll);\n\tvar storydata = window.document.querySelector(\"tw-storydata\");\n\tthis.story = Parser.get(storydata);\n\tthis.novel = new harrow_Runtime(this.story);\n\tthis.novel.onText = $bind(this,this.onText);\n\tthis.novel.onDialogue = $bind(this,this.onDialogue);\n\tthis.novel.onTransition = $bind(this,this.onTransition);\n\tthis.novel.onEvent = $bind(this,this.onEvent);\n\tthis.novel.onEnd = $bind(this,this.onEnd);\n\tthis.textbox = window.document.querySelector(\"textbox\");\n\tthis.dialogue = window.document.querySelector(\"dialogue\");\n\tthis.button = window.document.querySelector(\"button\");\n\tthis.button.textContent = \"Continue\";\n\tthis.button.style.display = \"none\";\n\tthis.button.onclick = function(event) {\n\t\t_gthis.onClick();\n\t};\n\twindow.document.querySelector(\"chapter\").innerHTML = storydata.getAttribute(\"name\");\n\twindow.document.querySelector(\"close\").onclick = function(event) {\n\t\t_gthis.close();\n\t};\n\twindow.document.querySelector(\"open\").onclick = function(event) {\n\t\t_gthis.open(\"Settings\");\n\t};\n\tvar style = window.document.createElement(\"style\");\n\tstyle.innerHTML = window.document.querySelector(\"#twine-user-stylesheet\").innerHTML;\n\twindow.document.querySelector(\"body\").appendChild(style);\n\tvar script = window.document.createElement(\"script\");\n\tscript.innerHTML = window.document.querySelector(\"#twine-user-script\").innerHTML;\n\twindow.document.querySelector(\"body\").appendChild(script);\n\tthis.novel.nextPage();\n};\nApp.__name__ = true;\nApp.main = function() {\n\tApp.ME = new App();\n};\nApp.prototype = {\n\tonClick: function() {\n\t\tthis.button.style.display = \"none\";\n\t\tthis.novel.nextPage();\n\t}\n\t,showText: function() {\n\t\tthis.textbox.innerHTML = this.buffer;\n\t\tthis.buffer = \"\";\n\t\tthis.textbox.style.opacity = \"0\";\n\t\t$(this.textbox).fadeTo(300,1);\n\t}\n\t,onText: function(text,name) {\n\t\tvar speaker = name != \"\" ? \"<span class = \\\"speaker\\\">\" + name + \"</span>\" : \"\";\n\t\tvar element = name != \"\" ? \"<p class = \\\"\" + name + \"\\\">\" : \"<p>\";\n\t\tif(!this.parsespeaker && name != \"\") {\n\t\t\tspeaker = name + \": \";\n\t\t}\n\t\tthis.buffer = this.buffer + element + speaker + this.decode(text) + \"</p>\";\n\t\tvar ready = this.buffer.length > this.maxlenght;\n\t\tvar page = this.novel.story.look(this.novel.story.page + 1);\n\t\tvar last = page == null;\n\t\tif(last) {\n\t\t\tthis.button.style.display = \"block\";\n\t\t\tthis.showText();\n\t\t}\n\t\tif(last) {\n\t\t\treturn;\n\t\t}\n\t\tif(page.type == \"dialogue\" && ready) {\n\t\t\tthis.novel.nextPage();\n\t\t}\n\t\tif(page.type != \"dialogue\" && ready) {\n\t\t\tthis.button.style.display = \"block\";\n\t\t\tthis.showText();\n\t\t}\n\t\tif(ready) {\n\t\t\treturn;\n\t\t}\n\t\tif(page.type == \"text\" || page.type == \"dialogue\") {\n\t\t\tthis.novel.nextPage();\n\t\t} else {\n\t\t\tthis.button.style.display = \"block\";\n\t\t\tthis.showText();\n\t\t}\n\t}\n\t,onDialogue: function(choices) {\n\t\tvar _gthis = this;\n\t\tif(this.buffer.length > 0) {\n\t\t\tthis.showText();\n\t\t}\n\t\tvar _g = 0;\n\t\twhile(_g < choices.length) {\n\t\t\tvar entry = [choices[_g]];\n\t\t\t++_g;\n\t\t\tvar choice = window.document.createElement(\"choice\");\n\t\t\tchoice.setAttribute(\"role\",\"button\");\n\t\t\tchoice.innerHTML = this.format(entry[0].text);\n\t\t\tvar allowed = entry[0].mode == \"empty\" ? true : harrow_Logic.condition(entry[0].mode);\n\t\t\tif(!allowed) {\n\t\t\t\tchoice.className = \"disabled\";\n\t\t\t}\n\t\t\tchoice.onclick = (function(entry) {\n\t\t\t\treturn function(event) {\n\t\t\t\t\t_gthis.onSelect(entry[0].type,entry[0].data);\n\t\t\t\t};\n\t\t\t})(entry);\n\t\t\tthis.dialogue.appendChild(choice);\n\t\t}\n\t}\n\t,onSelect: function(type,data) {\n\t\tthis.dialogue.innerHTML = \"\";\n\t\tthis.textbox.innerHTML = \"\";\n\t\tthis.novel.onChoice(type,data);\n\t}\n\t,onEvent: function(type,data) {\n\t\tswitch(type) {\n\t\tcase \"config.assets.folder\":\n\t\t\tthis.folder = data;\n\t\t\tbreak;\n\t\tcase \"config.parse.speaker\":\n\t\t\tthis.parsespeaker = data == \"true\";\n\t\t\tbreak;\n\t\tcase \"config.text.maxlenght\":\n\t\t\tthis.maxlenght = Std.parseInt(data);\n\t\t\tbreak;\n\t\tcase \"image\":\n\t\t\tthis.imageEvent(data);\n\t\t\tbreak;\n\t\tcase \"scene\":\n\t\t\tthis.sceneEvent(data);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tthis.screenEvent(type,data);\n\t\t}\n\t}\n\t,sceneEvent: function(data) {\n\t\tif(data == \"close\") {\n\t\t\tvar page = this.bookmark.pop();\n\t\t\tif(page != null) {\n\t\t\t\tthis.story.turn(page);\n\t\t\t}\n\t\t} else if(data == \"clear\") {\n\t\t\tthis.bookmark = [];\n\t\t} else {\n\t\t\tthis.bookmark.push(this.story.page);\n\t\t\tthis.story.move(data);\n\t\t}\n\t}\n\t,imageEvent: function(data) {\n\t\tvar element = window.document.querySelector(\"imagebox\");\n\t\tif(data == \"show\") {\n\t\t\twindow.document.querySelector(\"page\").className = \"novel\";\n\t\t\telement.style.display = \"block\";\n\t\t} else if(data == \"hide\") {\n\t\t\twindow.document.querySelector(\"page\").removeAttribute(\"class\");\n\t\t\telement.style.display = \"none\";\n\t\t} else {\n\t\t\twindow.document.querySelector(\"page\").className = \"novel\";\n\t\t\telement.style.display = \"block\";\n\t\t\tvar tmp = \"url('\" + this.folder + this.decode(data);\n\t\t\telement.style.backgroundImage = tmp + \"')\";\n\t\t\telement.style.opacity = \"0\";\n\t\t\t$(element).fadeTo(300,1);\n\t\t}\n\t}\n\t,screenEvent: function(name,data) {\n\t\tvar entry = data.split(\":\");\n\t\tvar type = entry.shift();\n\t\tvar text = entry.join(\" \");\n\t\tvar element = window.document.querySelector(name);\n\t\tif(element == null) {\n\t\t\treturn;\n\t\t}\n\t\ttext = this.decode(text);\n\t\tif(type != null) {\n\t\t\tswitch(type) {\n\t\t\tcase \"add\":\n\t\t\t\tvar item = window.document.createElement(text);\n\t\t\t\telement.appendChild(item);\n\t\t\t\tbreak;\n\t\t\tcase \"after\":\n\t\t\t\tvar item = window.document.createElement(text);\n\t\t\t\telement.parentNode.insertBefore(item,element.nextSibling);\n\t\t\t\tbreak;\n\t\t\tcase \"append\":\n\t\t\t\telement.innerHTML += this.format(text);\n\t\t\t\tbreak;\n\t\t\tcase \"before\":\n\t\t\t\tvar item = window.document.createElement(text);\n\t\t\t\telement.parentNode.insertBefore(item,element);\n\t\t\t\tbreak;\n\t\t\tcase \"class\":\n\t\t\t\telement.setAttribute(\"class\",text);\n\t\t\t\tif(text == \"default\") {\n\t\t\t\t\telement.removeAttribute(\"class\");\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase \"css\":\n\t\t\t\tvar position = text.indexOf(\" \");\n\t\t\t\tvar prop = text.substring(0,position);\n\t\t\t\tvar data = text.substring(position + 1,text.length);\n\t\t\t\telement.style.setProperty(prop,data);\n\t\t\t\tbreak;\n\t\t\tcase \"hide\":\n\t\t\t\telement.style.display = \"none\";\n\t\t\t\tbreak;\n\t\t\tcase \"html\":\n\t\t\t\telement.innerHTML = text == \"empty\" ? \"\" : this.format(text);\n\t\t\t\tbreak;\n\t\t\tcase \"id\":\n\t\t\t\telement.setAttribute(\"id\",text);\n\t\t\t\tif(text == \"default\") {\n\t\t\t\t\telement.removeAttribute(\"id\");\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase \"image\":\n\t\t\t\telement.style.backgroundImage = \"url('\" + this.folder + text + \"')\";\n\t\t\t\telement.style.opacity = \"0\";\n\t\t\t\t$(element).fadeTo(300,1);\n\t\t\t\tbreak;\n\t\t\tcase \"onclick\":\n\t\t\t\telement.setAttribute(\"onclick\",this.format(text));\n\t\t\t\tbreak;\n\t\t\tcase \"remove\":\n\t\t\t\telement.parentNode.removeChild(element);\n\t\t\t\tbreak;\n\t\t\tcase \"show\":\n\t\t\t\telement.style.display = \"block\";\n\t\t\t\tbreak;\n\t\t\tcase \"text\":\n\t\t\t\telement.textContent = text == \"empty\" ? \"\" : this.format(text);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t}\n\t\t}\n\t}\n\t,onTransition: function(name) {\n\t\tvar _gthis = this;\n\t\tvar hide = function() {\n\t\t\tvar transition = window.document.querySelector(\"transition\");\n\t\t\ttransition.style.zIndex = \"-1\";\n\t\t};\n\t\tvar fade = function() {\n\t\t\tvar transition = window.document.querySelector(\"transition\");\n\t\t\ttransition.className = \"off\";\n\t\t\thaxe_Timer.delay(hide,600);\n\t\t\t_gthis.novel.nextPage();\n\t\t};\n\t\tvar transition = window.document.querySelector(\"transition\");\n\t\ttransition.style.zIndex = \"600\";\n\t\ttransition.className = \"active\";\n\t\thaxe_Timer.delay(fade,900);\n\t}\n\t,onEnd: function() {\n\t\tthis.textbox.innerHTML = \"<p>Story End.</p>\";\n\t\t$(this.textbox).fadeTo(300,1);\n\t}\n\t,open: function(name) {\n\t\tvar page = this.story.find(\"route\",name);\n\t\tif(page == null) {\n\t\t\treturn;\n\t\t}\n\t\tvar skip = false;\n\t\tvar string = \"\";\n\t\t++page;\n\t\tvar _g = page;\n\t\tvar _g1 = this.story.data.length;\n\t\twhile(_g < _g1) {\n\t\t\tvar i = _g++;\n\t\t\tif(this.story.data[i].type == \"route\") {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif(this.story.data[i].type == \"condition\") {\n\t\t\t\tif(skip && this.story.data[i].text == \"else\" || skip && this.story.data[i].text == \"end\") {\n\t\t\t\t\tskip = false;\n\t\t\t\t} else {\n\t\t\t\t\tskip = !harrow_Logic.condition(this.story.data[i].text);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif(skip) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif(this.story.data[i].type == \"text\") {\n\t\t\t\tvar speaker = this.story.data[i].data;\n\t\t\t\tvar element = speaker != \"\" ? \"<p class = \\\"\" + speaker + \"\\\">\" : \"<p>\";\n\t\t\t\tstring = string + element + this.story.data[i].text + \"</p>\";\n\t\t\t}\n\t\t\tif(this.story.data[i].type == \"event\") {\n\t\t\t\tvar element1 = StringTools.replace(this.story.data[i].text,\":\",\" \");\n\t\t\t\telement1 = this.story.data[i].data + \" \" + this.decode(element1);\n\t\t\t\telement1 = this.format(element1);\n\t\t\t\tstring += element1;\n\t\t\t}\n\t\t}\n\t\twindow.document.querySelector(\"close\").style.zIndex = \"400\";\n\t\tvar element = window.document.querySelector(\"settings\");\n\t\telement.innerHTML = \"<content>\" + string + \"</content>\";\n\t\telement.setAttribute(\"class\",name.toLowerCase());\n\t\telement.style.display = \"grid\";\n\t\telement.style.zIndex = \"300\";\n\t\telement.style.opacity = \"1\";\n\t}\n\t,close: function() {\n\t\twindow.document.querySelector(\"close\").style.zIndex = \"-1\";\n\t\tvar element = window.document.querySelector(\"settings\");\n\t\telement.removeAttribute(\"class\");\n\t\telement.style.display = \"none\";\n\t\telement.style.opacity = \"0\";\n\t\telement.style.zIndex = \"-1\";\n\t}\n\t,get: function(key) {\n\t\treturn harrow_Storage.get(key);\n\t}\n\t,set: function(key,value) {\n\t\tharrow_Storage.set(key,value);\n\t}\n\t,decode: function(entry) {\n\t\tentry = StringTools.replace(entry,\"https \",\"https:\");\n\t\tentry = StringTools.replace(entry,\"http \",\"http:\");\n\t\treturn entry;\n\t}\n\t,format: function(entry) {\n\t\tif(entry.indexOf(\"$\") == -1) {\n\t\t\treturn entry;\n\t\t}\n\t\tvar rex = new EReg(\"\\\\$\\\\S+?(?=[^a-zA-Z.]|$)\",\"g\");\n\t\tentry = rex.map(entry,function(r) {\n\t\t\tvar matching = r.matched(0);\n\t\t\tvar variable = matching.substring(1,matching.length);\n\t\t\tif(harrow_Storage.has(variable)) {\n\t\t\t\treturn harrow_Storage.get(variable);\n\t\t\t}\n\t\t\treturn matching;\n\t\t});\n\t\treturn entry;\n\t}\n};\nvar Dice = function() {\n};\nDice.__name__ = true;\nDice.prototype = {\n\troll: function(entry) {\n\t\tvar text = entry.toLowerCase();\n\t\tvar keys = text.split(\"d\");\n\t\tif(keys.length == 1) {\n\t\t\treturn this.rollDice(1,Std.parseInt(text));\n\t\t}\n\t\tvar pool = Std.parseInt(keys.shift());\n\t\tvar side = keys.shift();\n\t\tvar type = side.charAt(side.length - 1);\n\t\tif(type == \"h\" || type == \"l\") {\n\t\t\tside = side.substring(0,side.length - 1);\n\t\t}\n\t\tvar rolls = [];\n\t\tvar total = 0;\n\t\tvar _g = 0;\n\t\tvar _g1 = pool;\n\t\twhile(_g < _g1) {\n\t\t\tvar i = _g++;\n\t\t\tvar take = this.rollDice(1,Std.parseInt(side));\n\t\t\ttotal += take;\n\t\t\trolls.push(take);\n\t\t}\n\t\trolls.sort(function(a,b) {\n\t\t\treturn a - b;\n\t\t});\n\t\tif(type == \"l\") {\n\t\t\treturn rolls.shift();\n\t\t}\n\t\tif(type == \"h\") {\n\t\t\treturn rolls.pop();\n\t\t}\n\t\treturn total;\n\t}\n\t,rollDice: function(min,max) {\n\t\treturn min + Math.floor((max - min + 1) * Math.random());\n\t}\n};\nvar EReg = function(r,opt) {\n\tthis.r = new RegExp(r,opt.split(\"u\").join(\"\"));\n};\nEReg.__name__ = true;\nEReg.prototype = {\n\tmatch: function(s) {\n\t\tif(this.r.global) {\n\t\t\tthis.r.lastIndex = 0;\n\t\t}\n\t\tthis.r.m = this.r.exec(s);\n\t\tthis.r.s = s;\n\t\treturn this.r.m != null;\n\t}\n\t,matched: function(n) {\n\t\tif(this.r.m != null && n >= 0 && n < this.r.m.length) {\n\t\t\treturn this.r.m[n];\n\t\t} else {\n\t\t\tthrow haxe_Exception.thrown(\"EReg::matched\");\n\t\t}\n\t}\n\t,matchedPos: function() {\n\t\tif(this.r.m == null) {\n\t\t\tthrow haxe_Exception.thrown(\"No string matched\");\n\t\t}\n\t\treturn { pos : this.r.m.index, len : this.r.m[0].length};\n\t}\n\t,matchSub: function(s,pos,len) {\n\t\tif(len == null) {\n\t\t\tlen = -1;\n\t\t}\n\t\tif(this.r.global) {\n\t\t\tthis.r.lastIndex = pos;\n\t\t\tthis.r.m = this.r.exec(len < 0 ? s : HxOverrides.substr(s,0,pos + len));\n\t\t\tvar b = this.r.m != null;\n\t\t\tif(b) {\n\t\t\t\tthis.r.s = s;\n\t\t\t}\n\t\t\treturn b;\n\t\t} else {\n\t\t\tvar b = this.match(len < 0 ? HxOverrides.substr(s,pos,null) : HxOverrides.substr(s,pos,len));\n\t\t\tif(b) {\n\t\t\t\tthis.r.s = s;\n\t\t\t\tthis.r.m.index += pos;\n\t\t\t}\n\t\t\treturn b;\n\t\t}\n\t}\n\t,map: function(s,f) {\n\t\tvar offset = 0;\n\t\tvar buf_b = \"\";\n\t\tdo {\n\t\t\tif(offset >= s.length) {\n\t\t\t\tbreak;\n\t\t\t} else if(!this.matchSub(s,offset)) {\n\t\t\t\tbuf_b += Std.string(HxOverrides.substr(s,offset,null));\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tvar p = this.matchedPos();\n\t\t\tbuf_b += Std.string(HxOverrides.substr(s,offset,p.pos - offset));\n\t\t\tbuf_b += Std.string(f(this));\n\t\t\tif(p.len == 0) {\n\t\t\t\tbuf_b += Std.string(HxOverrides.substr(s,p.pos,1));\n\t\t\t\toffset = p.pos + 1;\n\t\t\t} else {\n\t\t\t\toffset = p.pos + p.len;\n\t\t\t}\n\t\t} while(this.r.global);\n\t\tif(!this.r.global && offset > 0 && offset < s.length) {\n\t\t\tbuf_b += Std.string(HxOverrides.substr(s,offset,null));\n\t\t}\n\t\treturn buf_b;\n\t}\n};\nvar HxOverrides = function() { };\nHxOverrides.__name__ = true;\nHxOverrides.cca = function(s,index) {\n\tvar x = s.charCodeAt(index);\n\tif(x != x) {\n\t\treturn undefined;\n\t}\n\treturn x;\n};\nHxOverrides.substr = function(s,pos,len) {\n\tif(len == null) {\n\t\tlen = s.length;\n\t} else if(len < 0) {\n\t\tif(pos == 0) {\n\t\t\tlen = s.length + len;\n\t\t} else {\n\t\t\treturn \"\";\n\t\t}\n\t}\n\treturn s.substr(pos,len);\n};\nHxOverrides.now = function() {\n\treturn Date.now();\n};\nMath.__name__ = true;\nvar Parser = function() { };\nParser.__name__ = true;\nParser.get = function(storydata) {\n\tvar entry = \"\";\n\tvar start = \"\";\n\tvar startnode = storydata.getAttribute(\"startnode\");\n\tvar passages = storydata.children;\n\tvar _g = 0;\n\twhile(_g < passages.length) {\n\t\tvar passage = passages[_g];\n\t\t++_g;\n\t\tvar name = passage.getAttribute(\"name\");\n\t\tvar pid = passage.getAttribute(\"pid\");\n\t\tif(name != null) {\n\t\t\tentry += \"#\" + name + \"\\n\";\n\t\t\tif(pid == startnode) {\n\t\t\t\tstart = name;\n\t\t\t}\n\t\t\tvar content = passage.innerHTML.split(\"\\n\");\n\t\t\tvar _g1 = 0;\n\t\t\twhile(_g1 < content.length) {\n\t\t\t\tvar line = content[_g1];\n\t\t\t\t++_g1;\n\t\t\t\tvar string = StringTools.trim(line);\n\t\t\t\tvar lead = string.substring(0,1);\n\t\t\t\tvar link = string.substring(0,2);\n\t\t\t\tif(lead == \"-\") {\n\t\t\t\t\tstring = StringTools.replace(string,\"[[\",\"\");\n\t\t\t\t\tstring = StringTools.replace(string,\"]]\",\"\");\n\t\t\t\t}\n\t\t\t\tif(link == \"[[\") {\n\t\t\t\t\tstring = StringTools.replace(string,\"[[\",\"\");\n\t\t\t\t\tstring = StringTools.replace(string,\"]]\",\"\");\n\t\t\t\t\tstring = \"[move \" + string + \"]\";\n\t\t\t\t}\n\t\t\t\tstring = StringTools.replace(string,\"&lt;\",\"<\");\n\t\t\t\tstring = StringTools.replace(string,\"&gt;\",\">\");\n\t\t\t\tentry += string + \"\\n\";\n\t\t\t}\n\t\t}\n\t}\n\tvar story = harrow_Library.get(entry);\n\tstory.move(start);\n\treturn story;\n};\nvar Std = function() { };\nStd.__name__ = true;\nStd.string = function(s) {\n\treturn js_Boot.__string_rec(s,\"\");\n};\nStd.parseInt = function(x) {\n\tvar v = parseInt(x);\n\tif(isNaN(v)) {\n\t\treturn null;\n\t}\n\treturn v;\n};\nvar StringTools = function() { };\nStringTools.__name__ = true;\nStringTools.isSpace = function(s,pos) {\n\tvar c = HxOverrides.cca(s,pos);\n\tif(!(c > 8 && c < 14)) {\n\t\treturn c == 32;\n\t} else {\n\t\treturn true;\n\t}\n};\nStringTools.ltrim = function(s) {\n\tvar l = s.length;\n\tvar r = 0;\n\twhile(r < l && StringTools.isSpace(s,r)) ++r;\n\tif(r > 0) {\n\t\treturn HxOverrides.substr(s,r,l - r);\n\t} else {\n\t\treturn s;\n\t}\n};\nStringTools.rtrim = function(s) {\n\tvar l = s.length;\n\tvar r = 0;\n\twhile(r < l && StringTools.isSpace(s,l - r - 1)) ++r;\n\tif(r > 0) {\n\t\treturn HxOverrides.substr(s,0,l - r);\n\t} else {\n\t\treturn s;\n\t}\n};\nStringTools.trim = function(s) {\n\treturn StringTools.ltrim(StringTools.rtrim(s));\n};\nStringTools.replace = function(s,sub,by) {\n\treturn s.split(sub).join(by);\n};\nvar harrow_Choice = function() {\n\tthis.mode = \"empty\";\n\tthis.data = \"empty\";\n\tthis.text = \"empty\";\n\tthis.type = \"empty\";\n};\nharrow_Choice.__name__ = true;\nvar harrow_Dialogue = function() { };\nharrow_Dialogue.__name__ = true;\nharrow_Dialogue.get = function(entry) {\n\tvar map = entry.split(harrow_Library.LINE);\n\tvar choices = [];\n\tvar _g = 0;\n\tvar _g1 = map.length;\n\twhile(_g < _g1) {\n\t\tvar i = _g++;\n\t\tvar key = map[i].split(harrow_Library.ITEM);\n\t\tvar choice = new harrow_Choice();\n\t\tchoice.text = key[0];\n\t\tchoice.type = key[1];\n\t\tchoice.data = key[2];\n\t\tchoice.mode = key[3];\n\t\tchoices.push(choice);\n\t}\n\treturn choices;\n};\nvar harrow_Format = function() { };\nharrow_Format.__name__ = true;\nharrow_Format.variable = function(entry) {\n\tif(entry.indexOf(\"[\") == -1) {\n\t\treturn entry;\n\t}\n\tvar rex = new EReg(\"\\\\[(.*?)\\\\]\",\"gi\");\n\tentry = rex.map(entry,function(r) {\n\t\tvar matching = r.matched(0);\n\t\tvar variable = matching.substring(1,matching.length - 1);\n\t\tif(harrow_Storage.has(variable)) {\n\t\t\treturn harrow_Storage.get(variable);\n\t\t}\n\t\treturn matching;\n\t});\n\treturn entry;\n};\nvar harrow_Library = function() { };\nharrow_Library.__name__ = true;\nharrow_Library.get = function(entry,validate) {\n\tif(validate == null) {\n\t\tvalidate = true;\n\t}\n\tvar res = entry.split(\"\\n\");\n\tvar story = new harrow_Story();\n\tvar last = null;\n\tvar _g = 0;\n\twhile(_g < res.length) {\n\t\tvar line = res[_g];\n\t\t++_g;\n\t\tvar page = harrow_Library.parse(line);\n\t\tvar skip = harrow_Library.merge(page,last);\n\t\tif(page == null) {\n\t\t\tlast = null;\n\t\t}\n\t\tif(page == null) {\n\t\t\tskip = true;\n\t\t}\n\t\tif(skip == false) {\n\t\t\tstory.data.push(page);\n\t\t\tlast = page;\n\t\t}\n\t}\n\tif(validate) {\n\t\tharrow_Syntax.validate(story);\n\t}\n\treturn story;\n};\nharrow_Library.parse = function(entry) {\n\tvar string = StringTools.trim(entry);\n\tif(string.length == 0) {\n\t\treturn null;\n\t}\n\tif(string.substring(0,1) == \"/\") {\n\t\treturn null;\n\t}\n\tvar page = new harrow_Page();\n\tpage.type = \"text\";\n\tvar leading = string.substring(0,1);\n\tif(leading == \"#\") {\n\t\tpage.type = \"route\";\n\t}\n\tif(leading == \"-\") {\n\t\tpage.type = \"dialogue\";\n\t}\n\tif(leading == \"[\") {\n\t\tpage.type = harrow_Library.isEvent(string);\n\t}\n\tif(harrow_Library.isBreak(string)) {\n\t\tpage.type = \"break\";\n\t}\n\tswitch(page.type) {\n\tcase \"dialogue\":\n\t\tharrow_Library.getDialogue(page,string);\n\t\tbreak;\n\tcase \"event\":\n\t\tharrow_Library.getEvent(page,string);\n\t\tbreak;\n\tcase \"route\":\n\t\tharrow_Library.getRoute(page,string);\n\t\tbreak;\n\tcase \"text\":\n\t\tharrow_Library.getText(page,string);\n\t\tbreak;\n\tdefault:\n\t}\n\treturn page;\n};\nharrow_Library.merge = function(page,last) {\n\tif(page != null && page.type == \"dialogue\" && last != null && last.type == \"dialogue\") {\n\t\tlast.text = last.text + harrow_Library.LINE + page.text;\n\t\tlast.data = \"dialogue\";\n\t\treturn true;\n\t}\n\treturn false;\n};\nharrow_Library.getText = function(page,entry) {\n\tvar raw = StringTools.replace(entry,harrow_Library.colonEscape,harrow_Library.LINE);\n\tvar key = raw.split(harrow_Library.KEY);\n\tpage.text = StringTools.trim(key.pop());\n\tpage.text = StringTools.replace(page.text,harrow_Library.LINE,harrow_Library.KEY);\n\tpage.data = key.length > 0 ? StringTools.trim(key[harrow_Library.TYPE]) : \"\";\n};\nharrow_Library.getRoute = function(page,entry) {\n\tvar locked = entry.substring(0,2) != harrow_Library.HASH + harrow_Library.HASH;\n\tpage.text = StringTools.trim(StringTools.replace(entry,harrow_Library.HASH,\"\"));\n\tpage.data = locked ? \"route\" : \"label\";\n};\nharrow_Library.getDialogue = function(page,entry) {\n\tvar res = StringTools.replace(entry,harrow_Library.DASH,\"\");\n\tvar key = res.split(harrow_Library.KEY);\n\tvar text = StringTools.trim(key[harrow_Library.TYPE]);\n\tvar type = \"empty\";\n\tvar data = \"empty\";\n\tvar mode = \"empty\";\n\tif(key.length > 1) {\n\t\tvar string = StringTools.trim(key[harrow_Library.TEXT]);\n\t\tstring = StringTools.replace(string,harrow_Library.SPACE,harrow_Library.KEY);\n\t\tvar prop = string.split(harrow_Library.KEY);\n\t\tif(harrow_Library.isVariable(prop[harrow_Library.TEXT])) {\n\t\t\ttype = \"variable\";\n\t\t\tdata = string;\n\t\t} else {\n\t\t\ttype = \"route\";\n\t\t\tdata = StringTools.trim(key[harrow_Library.TEXT]);\n\t\t}\n\t}\n\tif(key.length > 2) {\n\t\tmode = StringTools.trim(key[harrow_Library.DATA]);\n\t\tmode = StringTools.replace(mode,harrow_Library.SPACE,harrow_Library.KEY);\n\t}\n\tpage.text = text + harrow_Library.ITEM + type + harrow_Library.ITEM + data + harrow_Library.ITEM + mode;\n\tpage.data = \"button\";\n};\nharrow_Library.getEvent = function(page,entry) {\n\tvar string = entry.substring(1,entry.length - 1);\n\tstring = StringTools.trim(string);\n\tstring = StringTools.replace(string,harrow_Library.COMA + harrow_Library.SPACE,harrow_Library.COMA);\n\tstring = StringTools.replace(string,harrow_Library.SPACE + harrow_Library.SPACE,harrow_Library.KEY);\n\tstring = StringTools.replace(string,harrow_Library.SPACE,harrow_Library.KEY);\n\tvar key = string.split(harrow_Library.KEY);\n\tvar type = key[harrow_Library.TYPE];\n\tpage.type = \"event\";\n\tpage.text = StringTools.replace(string,type + \":\",\"\");\n\tpage.data = type;\n\tif(type == \"story\" || type == \"move\") {\n\t\tpage.type = \"move\";\n\t\tpage.text = StringTools.replace(page.text,harrow_Library.KEY,harrow_Library.SPACE);\n\t}\n\tif(type == \"lock\" || type == \"close\") {\n\t\tpage.type = \"move\";\n\t}\n\tif(type == \"if\") {\n\t\tpage.type = \"condition\";\n\t\tpage.text = StringTools.replace(string,\"if:\",\"\");\n\t}\n\tif(type == \"else\" || type == \"end\") {\n\t\tpage.type = \"condition\";\n\t\tpage.text = type;\n\t}\n\tif(harrow_Library.isVariable(key[harrow_Library.TEXT])) {\n\t\tpage.type = \"variable\";\n\t\tpage.text = string;\n\t}\n};\nharrow_Library.isBreak = function(entry) {\n\tif(entry.length >= 2 && entry.substring(0,2) == harrow_Library.DASH + harrow_Library.DASH) {\n\t\treturn true;\n\t}\n\treturn false;\n};\nharrow_Library.isEvent = function(entry) {\n\tif(entry.indexOf(\"]\") != entry.length - 1) {\n\t\treturn \"text\";\n\t}\n\treturn \"event\";\n};\nharrow_Library.isVariable = function(entry) {\n\tif(entry == \"=\" || entry == \"+\" || entry == \"-\" || entry == \"*\" || entry == \"/\") {\n\t\treturn true;\n\t}\n\tif(entry == \"is\" || entry == \"roll\" || entry == \"chance\") {\n\t\treturn true;\n\t}\n\treturn false;\n};\nvar harrow_Logic = function() { };\nharrow_Logic.__name__ = true;\nharrow_Logic.variable = function(entry) {\n\tvar key = entry.split(harrow_Library.KEY);\n\tvar name = key.shift();\n\tvar type = key.shift();\n\tvar prop = key.join(harrow_Library.SPACE);\n\tif(type != null) {\n\t\tswitch(type) {\n\t\tcase \"*\":\n\t\t\tvar number = parseFloat(harrow_Logic.get(name));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + name + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar a = number;\n\t\t\tvar number = parseFloat(harrow_Logic.get(prop));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + prop + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar b = number;\n\t\t\tharrow_Logic.set(name,Std.string(a * b));\n\t\t\tbreak;\n\t\tcase \"+\":\n\t\t\tvar number = parseFloat(harrow_Logic.get(name));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + name + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar a = number;\n\t\t\tvar number = parseFloat(harrow_Logic.get(prop));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + prop + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar b = number;\n\t\t\tharrow_Logic.set(name,Std.string(a + b));\n\t\t\tbreak;\n\t\tcase \"-\":\n\t\t\tvar number = parseFloat(harrow_Logic.get(name));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + name + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar a = number;\n\t\t\tvar number = parseFloat(harrow_Logic.get(prop));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + prop + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar b = number;\n\t\t\tharrow_Logic.set(name,Std.string(a - b));\n\t\t\tbreak;\n\t\tcase \"/\":\n\t\t\tvar number = parseFloat(harrow_Logic.get(name));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + name + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar a = number;\n\t\t\tvar number = parseFloat(harrow_Logic.get(prop));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + prop + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar b = number;\n\t\t\tharrow_Logic.set(name,Std.string(a / b));\n\t\t\tbreak;\n\t\tcase \"=\":\n\t\t\tharrow_Logic.set(name,harrow_Logic.get(prop));\n\t\t\tbreak;\n\t\tcase \"chance\":\n\t\t\tvar prob = harrow_Random.chance(harrow_Logic.get(prop));\n\t\t\tharrow_Logic.set(name,prob == null ? \"null\" : \"\" + prob);\n\t\t\tbreak;\n\t\tcase \"roll\":\n\t\t\tvar roll = harrow_Random.dice(harrow_Logic.get(prop));\n\t\t\tharrow_Logic.set(name,roll == null ? \"null\" : \"\" + roll);\n\t\t\tbreak;\n\t\tdefault:\n\t\t}\n\t}\n};\nharrow_Logic.condition = function(entry) {\n\tif(entry == \"else\") {\n\t\treturn false;\n\t}\n\tif(entry == \"end\") {\n\t\treturn true;\n\t}\n\tvar key = entry.split(harrow_Library.KEY);\n\tvar name = key.shift();\n\tvar type = key.shift();\n\tvar prop = key.join(harrow_Library.SPACE);\n\tvar result = false;\n\tif(type != null) {\n\t\tswitch(type) {\n\t\tcase \"<\":\n\t\t\tvar number = parseFloat(harrow_Logic.get(name));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + name + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar a = number;\n\t\t\tvar number = parseFloat(harrow_Logic.get(prop));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + prop + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar b = number;\n\t\t\tresult = a < b;\n\t\t\tbreak;\n\t\tcase \"<=\":\n\t\t\tvar number = parseFloat(harrow_Logic.get(name));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + name + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar a = number;\n\t\t\tvar number = parseFloat(harrow_Logic.get(prop));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + prop + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar b = number;\n\t\t\tresult = a <= b;\n\t\t\tbreak;\n\t\tcase \"=\":\n\t\t\tresult = harrow_Logic.get(name) == harrow_Logic.get(prop);\n\t\t\tbreak;\n\t\tcase \">\":\n\t\t\tvar number = parseFloat(harrow_Logic.get(name));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + name + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar a = number;\n\t\t\tvar number = parseFloat(harrow_Logic.get(prop));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + prop + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar b = number;\n\t\t\tresult = a > b;\n\t\t\tbreak;\n\t\tcase \">=\":\n\t\t\tvar number = parseFloat(harrow_Logic.get(name));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + name + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar a = number;\n\t\t\tvar number = parseFloat(harrow_Logic.get(prop));\n\t\t\tif(isNaN(number)) {\n\t\t\t\tthrow haxe_Exception.thrown(\"Invalid input format: \\\"\" + prop + \"\\\". Expected: number\");\n\t\t\t}\n\t\t\tvar b = number;\n\t\t\tresult = a >= b;\n\t\t\tbreak;\n\t\tcase \"chance\":\n\t\t\tresult = harrow_Random.chance(harrow_Logic.get(prop));\n\t\t\tbreak;\n\t\tcase \"is\":\n\t\t\tresult = harrow_Logic.get(name) == harrow_Logic.get(prop);\n\t\t\tbreak;\n\t\tdefault:\n\t\t}\n\t}\n\treturn result;\n};\nharrow_Logic.get = function(entry) {\n\tif(entry == \"false\" || entry == \"true\") {\n\t\treturn entry;\n\t}\n\tif(harrow_Storage.has(entry)) {\n\t\treturn harrow_Storage.get(entry);\n\t}\n\treturn entry;\n};\nharrow_Logic.set = function(entry,value) {\n\tharrow_Storage.set(entry,value);\n};\nvar harrow_Page = function() {\n\tthis.data = \"\";\n\tthis.text = \"\";\n\tthis.type = \"\";\n};\nharrow_Page.__name__ = true;\nvar harrow_Random = function() { };\nharrow_Random.__name__ = true;\nharrow_Random.chance = function(entry) {\n\treturn harrow_Random.roll(0,100) < Std.parseInt(entry);\n};\nharrow_Random.dice = function(entry) {\n\treturn harrow_Random.roll(1,Std.parseInt(entry));\n};\nharrow_Random.roll = function(min,max) {\n\treturn min + Math.floor((max - min + 1) * Math.random());\n};\nvar harrow_Runtime = function(entry) {\n\tthis.story = entry;\n};\nharrow_Runtime.__name__ = true;\nharrow_Runtime.prototype = {\n\tnextPage: function() {\n\t\tif(this.story.get_end()) {\n\t\t\tthis.onEnd();\n\t\t}\n\t\tif(this.story.get_end()) {\n\t\t\treturn;\n\t\t}\n\t\tthis.page = this.story.next();\n\t\tthis.onPage(this.page);\n\t\tswitch(this.page.type) {\n\t\tcase \"break\":\n\t\t\tthis.nextPage();\n\t\t\tbreak;\n\t\tcase \"condition\":\n\t\t\tvar condition = harrow_Logic.condition(this.page.text);\n\t\t\tif(condition == false) {\n\t\t\t\tthis.story.skip();\n\t\t\t}\n\t\t\tthis.nextPage();\n\t\t\tbreak;\n\t\tcase \"dialogue\":\n\t\t\tvar dialogue = harrow_Dialogue.get(this.page.text);\n\t\t\tvar _g = 0;\n\t\t\twhile(_g < dialogue.length) {\n\t\t\t\tvar choice = dialogue[_g];\n\t\t\t\t++_g;\n\t\t\t\tchoice.text = harrow_Format.variable(choice.text);\n\t\t\t}\n\t\t\tthis.onDialogue(dialogue);\n\t\t\tbreak;\n\t\tcase \"event\":\n\t\t\tthis.gameEvent();\n\t\t\tbreak;\n\t\tcase \"move\":\n\t\t\tif(this.page.data == \"story\") {\n\t\t\t\tthis.onStory(this.page.text);\n\t\t\t}\n\t\t\tif(this.page.data == \"close\") {\n\t\t\t\tthis.onClose();\n\t\t\t}\n\t\t\tif(this.page.data == \"move\") {\n\t\t\t\tthis.story.move(this.page.text);\n\t\t\t\tthis.nextPage();\n\t\t\t}\n\t\t\tbreak;\n\t\tcase \"route\":\n\t\t\tif(this.page.data == \"label\") {\n\t\t\t\tthis.nextPage();\n\t\t\t}\n\t\t\tbreak;\n\t\tcase \"text\":\n\t\t\tvar text = harrow_Format.variable(this.page.text);\n\t\t\tthis.onText(text,this.page.data);\n\t\t\tbreak;\n\t\tcase \"variable\":\n\t\t\tharrow_Logic.variable(this.page.text);\n\t\t\tthis.nextPage();\n\t\t\tbreak;\n\t\tdefault:\n\t\t}\n\t}\n\t,gameEvent: function() {\n\t\tswitch(this.page.data) {\n\t\tcase \"transition\":\n\t\t\tthis.onTransition(this.page.text);\n\t\t\tbreak;\n\t\tcase \"wait\":\n\t\t\tvar time = Std.parseInt(this.page.text);\n\t\t\thaxe_Timer.delay($bind(this,this.nextPage),time * 60);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tthis.onEvent(this.page.data,this.page.text);\n\t\t\tthis.nextPage();\n\t\t}\n\t}\n\t,onChoice: function(type,data) {\n\t\tif(type == \"route\") {\n\t\t\tthis.story.move(data);\n\t\t}\n\t\tif(type == \"variable\") {\n\t\t\tharrow_Logic.variable(data);\n\t\t}\n\t\tthis.nextPage();\n\t}\n\t,onPage: function(page) {\n\t}\n\t,onText: function(text,name) {\n\t}\n\t,onDialogue: function(dialogue) {\n\t}\n\t,onEvent: function(type,data) {\n\t}\n\t,onTransition: function(name) {\n\t}\n\t,onStory: function(name) {\n\t}\n\t,onClose: function() {\n\t}\n\t,onEnd: function() {\n\t}\n};\nvar haxe_ds_StringMap = function() {\n\tthis.h = Object.create(null);\n};\nhaxe_ds_StringMap.__name__ = true;\nvar harrow_Storage = function() { };\nharrow_Storage.__name__ = true;\nharrow_Storage.get = function(key) {\n\treturn harrow_Storage.variable.h[key];\n};\nharrow_Storage.set = function(key,value) {\n\tharrow_Storage.variable.h[key] = value;\n};\nharrow_Storage.has = function(key) {\n\treturn Object.prototype.hasOwnProperty.call(harrow_Storage.variable.h,key);\n};\nvar harrow_Story = function() {\n\tthis.page = -1;\n\tthis.data = [];\n};\nharrow_Story.__name__ = true;\nharrow_Story.prototype = {\n\tnext: function() {\n\t\tif(this.page < this.data.length) {\n\t\t\tthis.page += 1;\n\t\t}\n\t\treturn this.data[this.page];\n\t}\n\t,move: function(route) {\n\t\tvar _g = 0;\n\t\tvar _g1 = this.data.length;\n\t\twhile(_g < _g1) {\n\t\t\tvar i = _g++;\n\t\t\tif(this.data[i].type == \"route\" && this.data[i].text == route) {\n\t\t\t\treturn this.page = i;\n\t\t\t}\n\t\t}\n\t\treturn this.page;\n\t}\n\t,skip: function() {\n\t\tvar position = this.page + 1;\n\t\tvar _g = position;\n\t\tvar _g1 = this.data.length;\n\t\twhile(_g < _g1) {\n\t\t\tvar i = _g++;\n\t\t\tif(this.data[i].type == \"condition\") {\n\t\t\t\tif(this.data[i].text == \"end\" || this.data[i].text == \"else\") {\n\t\t\t\t\treturn this.page = i;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn this.page;\n\t}\n\t,turn: function(number) {\n\t\tif(number < 0 || number > this.data.length - 1) {\n\t\t\treturn this.page;\n\t\t}\n\t\treturn this.page = number;\n\t}\n\t,look: function(number) {\n\t\tif(number < 0 || number > this.data.length - 1) {\n\t\t\treturn null;\n\t\t}\n\t\treturn this.data[number];\n\t}\n\t,find: function(type,text) {\n\t\tvar _g = 0;\n\t\tvar _g1 = this.data.length;\n\t\twhile(_g < _g1) {\n\t\t\tvar i = _g++;\n\t\t\tif(this.data[i].type == type && this.data[i].text == text) {\n\t\t\t\treturn i;\n\t\t\t}\n\t\t\tif(text == \"any\" && this.data[i].type == type) {\n\t\t\t\treturn i;\n\t\t\t}\n\t\t\tif(type == \"any\" && this.data[i].text == text) {\n\t\t\t\treturn i;\n\t\t\t}\n\t\t}\n\t\treturn null;\n\t}\n\t,get_end: function() {\n\t\treturn this.page == this.data.length - 1;\n\t}\n};\nvar harrow_Syntax = function() { };\nharrow_Syntax.__name__ = true;\nharrow_Syntax.validate = function(story) {\n\tvar routes_h = Object.create(null);\n\tvar _g = 0;\n\tvar _g1 = story.data;\n\twhile(_g < _g1.length) {\n\t\tvar page = _g1[_g];\n\t\t++_g;\n\t\tif(page.type == \"route\" && page.data == \"route\") {\n\t\t\troutes_h[page.text] = false;\n\t\t}\n\t}\n\tvar _g = 0;\n\tvar _g1 = story.data;\n\twhile(_g < _g1.length) {\n\t\tvar page = _g1[_g];\n\t\t++_g;\n\t\tswitch(page.type) {\n\t\tcase \"condition\":\n\t\t\tif(page.data == \"if\") {\n\t\t\t\tif(page.text.split(harrow_Library.KEY).length < 3) {\n\t\t\t\t\tconsole.log(\"src/harrow/Syntax.hx:39:\",\"Warning: Invalid input format: \\\"\" + page.text + \"\\\". Expected: name:operator:value\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase \"dialogue\":\n\t\t\tvar lines = page.text.split(harrow_Library.LINE);\n\t\t\tvar _g2 = 0;\n\t\t\twhile(_g2 < lines.length) {\n\t\t\t\tvar line = lines[_g2];\n\t\t\t\t++_g2;\n\t\t\t\tvar parts = line.split(harrow_Library.ITEM);\n\t\t\t\tif(parts.length >= 3 && parts[1] == \"route\") {\n\t\t\t\t\tvar target = parts[2];\n\t\t\t\t\tif(Object.prototype.hasOwnProperty.call(routes_h,target)) {\n\t\t\t\t\t\troutes_h[target] = true;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconsole.log(\"src/harrow/Syntax.hx:32:\",\"Warning: Reference to undefined route \\\"\" + target + \"\\\"\");\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase \"move\":\n\t\t\tif(page.data == \"move\") {\n\t\t\t\tif(Object.prototype.hasOwnProperty.call(routes_h,page.text)) {\n\t\t\t\t\troutes_h[page.text] = true;\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log(\"src/harrow/Syntax.hx:19:\",\"Warning: Reference to undefined route \\\"\" + page.text + \"\\\"\");\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase \"variable\":\n\t\t\tif(page.text.split(harrow_Library.KEY).length < 3) {\n\t\t\t\tconsole.log(\"src/harrow/Syntax.hx:44:\",\"Warning: Invalid input format: \\\"\" + page.text + \"\\\". Expected: name:operator:value\");\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t}\n\t}\n\tvar h = routes_h;\n\tvar _g_h = h;\n\tvar _g_keys = Object.keys(h);\n\tvar _g_length = _g_keys.length;\n\tvar _g_current = 0;\n\twhile(_g_current < _g_length) {\n\t\tvar key = _g_keys[_g_current++];\n\t\tvar _g_key = key;\n\t\tvar _g_value = _g_h[key];\n\t\tvar route = _g_key;\n\t\tvar reference = _g_value;\n\t\tif(!reference) {\n\t\t\tconsole.log(\"src/harrow/Syntax.hx:52:\",\"Warning: Route \\\"\" + route + \"\\\" may be unreachable\");\n\t\t}\n\t}\n};\nvar haxe_Exception = function(message,previous,native) {\n\tError.call(this,message);\n\tthis.message = message;\n\tthis.__previousException = previous;\n\tthis.__nativeException = native != null ? native : this;\n};\nhaxe_Exception.__name__ = true;\nhaxe_Exception.thrown = function(value) {\n\tif(((value) instanceof haxe_Exception)) {\n\t\treturn value.get_native();\n\t} else if(((value) instanceof Error)) {\n\t\treturn value;\n\t} else {\n\t\tvar e = new haxe_ValueException(value);\n\t\treturn e;\n\t}\n};\nhaxe_Exception.__super__ = Error;\nhaxe_Exception.prototype = $extend(Error.prototype,{\n\tget_native: function() {\n\t\treturn this.__nativeException;\n\t}\n});\nvar haxe_Timer = function(time_ms) {\n\tvar me = this;\n\tthis.id = setInterval(function() {\n\t\tme.run();\n\t},time_ms);\n};\nhaxe_Timer.__name__ = true;\nhaxe_Timer.delay = function(f,time_ms) {\n\tvar t = new haxe_Timer(time_ms);\n\tt.run = function() {\n\t\tt.stop();\n\t\tf();\n\t};\n\treturn t;\n};\nhaxe_Timer.prototype = {\n\tstop: function() {\n\t\tif(this.id == null) {\n\t\t\treturn;\n\t\t}\n\t\tclearInterval(this.id);\n\t\tthis.id = null;\n\t}\n\t,run: function() {\n\t}\n};\nvar haxe_ValueException = function(value,previous,native) {\n\thaxe_Exception.call(this,String(value),previous,native);\n\tthis.value = value;\n};\nhaxe_ValueException.__name__ = true;\nhaxe_ValueException.__super__ = haxe_Exception;\nhaxe_ValueException.prototype = $extend(haxe_Exception.prototype,{\n});\nvar haxe_iterators_ArrayIterator = function(array) {\n\tthis.current = 0;\n\tthis.array = array;\n};\nhaxe_iterators_ArrayIterator.__name__ = true;\nhaxe_iterators_ArrayIterator.prototype = {\n\thasNext: function() {\n\t\treturn this.current < this.array.length;\n\t}\n\t,next: function() {\n\t\treturn this.array[this.current++];\n\t}\n};\nvar js_Boot = function() { };\njs_Boot.__name__ = true;\njs_Boot.__string_rec = function(o,s) {\n\tif(o == null) {\n\t\treturn \"null\";\n\t}\n\tif(s.length >= 5) {\n\t\treturn \"<...>\";\n\t}\n\tvar t = typeof(o);\n\tif(t == \"function\" && (o.__name__ || o.__ename__)) {\n\t\tt = \"object\";\n\t}\n\tswitch(t) {\n\tcase \"function\":\n\t\treturn \"<function>\";\n\tcase \"object\":\n\t\tif(((o) instanceof Array)) {\n\t\t\tvar str = \"[\";\n\t\t\ts += \"\\t\";\n\t\t\tvar _g = 0;\n\t\t\tvar _g1 = o.length;\n\t\t\twhile(_g < _g1) {\n\t\t\t\tvar i = _g++;\n\t\t\t\tstr += (i > 0 ? \",\" : \"\") + js_Boot.__string_rec(o[i],s);\n\t\t\t}\n\t\t\tstr += \"]\";\n\t\t\treturn str;\n\t\t}\n\t\tvar tostr;\n\t\ttry {\n\t\t\ttostr = o.toString;\n\t\t} catch( _g ) {\n\t\t\treturn \"???\";\n\t\t}\n\t\tif(tostr != null && tostr != Object.toString && typeof(tostr) == \"function\") {\n\t\t\tvar s2 = o.toString();\n\t\t\tif(s2 != \"[object Object]\") {\n\t\t\t\treturn s2;\n\t\t\t}\n\t\t}\n\t\tvar str = \"{\\n\";\n\t\ts += \"\\t\";\n\t\tvar hasp = o.hasOwnProperty != null;\n\t\tvar k = null;\n\t\tfor( k in o ) {\n\t\tif(hasp && !o.hasOwnProperty(k)) {\n\t\t\tcontinue;\n\t\t}\n\t\tif(k == \"prototype\" || k == \"__class__\" || k == \"__super__\" || k == \"__interfaces__\" || k == \"__properties__\") {\n\t\t\tcontinue;\n\t\t}\n\t\tif(str.length != 2) {\n\t\t\tstr += \", \\n\";\n\t\t}\n\t\tstr += s + k + \" : \" + js_Boot.__string_rec(o[k],s);\n\t\t}\n\t\ts = s.substring(1);\n\t\tstr += \"\\n\" + s + \"}\";\n\t\treturn str;\n\tcase \"string\":\n\t\treturn o;\n\tdefault:\n\t\treturn String(o);\n\t}\n};\nvar $_;\nfunction $bind(o,m) { if( m == null ) return null; if( m.__id__ == null ) m.__id__ = $global.$haxeUID++; var f; if( o.hx__closures__ == null ) o.hx__closures__ = {}; else f = o.hx__closures__[m.__id__]; if( f == null ) { f = m.bind(o); o.hx__closures__[m.__id__] = f; } return f; }\n$global.$haxeUID |= 0;\nif(typeof(performance) != \"undefined\" ? typeof(performance.now) == \"function\" : false) {\n\tHxOverrides.now = performance.now.bind(performance);\n}\nString.__name__ = true;\nArray.__name__ = true;\njs_Boot.__toStr = ({ }).toString;\nharrow_Library.SPACE = \" \";\nharrow_Library.LINE = \"|\";\nharrow_Library.ITEM = \"::\";\nharrow_Library.COMA = \",\";\nharrow_Library.HASH = \"#\";\nharrow_Library.DASH = \"-\";\nharrow_Library.KEY = \":\";\nharrow_Library.colonEscape = \"::\";\nharrow_Library.TYPE = 0;\nharrow_Library.TEXT = 1;\nharrow_Library.DATA = 2;\nharrow_Storage.variable = new haxe_ds_StringMap();\nApp.main();\n})(typeof exports != \"undefined\" ? exports : typeof window != \"undefined\" ? window : typeof self != \"undefined\" ? self : this, typeof window != \"undefined\" ? window : typeof global != \"undefined\" ? global : typeof self != \"undefined\" ? self : this);\n\r\n\t</script>\r\n</html>",
 	editorExtensions: {
		twine: {
			'^2.4.0-alpha1': {
				codeMirror: {
					commands: {
						insertMove(editor) {
							editor.replaceSelection('[move route]');
							editor.focus();
						},
						insertLoad(editor) {
							editor.replaceSelection('[story name]');
							editor.focus();
						},
						insertTransition(editor) {
							editor.replaceSelection('[transition name]');
							editor.focus();
						},
						insertWait(editor) {
							editor.replaceSelection('[wait time]');
							editor.focus();
						},
						insertClose(editor) {
							editor.replaceSelection('[close]');
							editor.focus();
						},
						insertLock(editor) {
							editor.replaceSelection('[lock]');
							editor.focus();
						},
						insertIf(editor) {
							editor.replaceSelection('[if condition]\n\n[end]');
							editor.focus();
						},
						insertIfElse(editor) {
							editor.replaceSelection('[if condition]\n\n[else]\n\n[end]');
							editor.focus();
						},
						insertVariable(editor) {
							editor.replaceSelection('[name = value]');
							editor.focus();
						},
						insertChance(editor) {
							editor.replaceSelection('[name chance value]');
							editor.focus();
						},
						insertDice(editor) {
							editor.replaceSelection('[name roll value]');
							editor.focus();
						},
						insertBrackets(editor) {
							editor.replaceSelection('[' + editor.getSelections() + ']');
							editor.focus();
						}
					},
					toolbar(editor, environment) {
						const iconColor = environment.appTheme === 'dark' ? 'hsl(0, 0%, 70%)' : 'hsl(0, 0%, 30%)';
						return [
							{
								type: 'menu',
								icon: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='${iconColor}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='icon icon-tabler icons-tabler-outline icon-tabler-sticker-2'%3E%3Cpath stroke='none' d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M6 4h12a2 2 0 0 1 2 2v7h-5a2 2 0 0 0 -2 2v5h-7a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2z' /%3E%3Cpath d='M20 13v.172a2 2 0 0 1 -.586 1.414l-4.828 4.828a2 2 0 0 1 -1.414 .586h-.172' /%3E%3C/svg%3E`,
								label: 'Story',
								items: [
									{
										type: 'button',
										command: 'insertMove',
										label: 'Move to route'
									},
									{
										type: 'button',
										command: 'insertLoad',
										label: 'Load story'
									},
									{type: 'separator'},
									{
										type: 'button',
										command: 'insertTransition',
										label: 'Transition'
									},
									{
										type: 'button',
										command: 'insertWait',
										label: 'Wait'
									},
									{type: 'separator'},
									{
										type: 'button',
										command: 'insertClose',
										label: 'Close'
									},
									{
										type: 'button',
										command: 'insertLock',
										label: 'Lock'
									}
								]
							},
							{
								type: 'menu',
								icon: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='${iconColor}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='icon icon-tabler icons-tabler-outline icon-tabler-edit'%3E%3Cpath stroke='none' d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1' /%3E%3Cpath d='M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z' /%3E%3Cpath d='M16 5l3 3' /%3E%3C/svg%3E`,
								label: 'Modifiers',
								items: [
									{
										type: 'button',
										command: 'insertIf',
										label: 'If'
									},
									{
										type: 'button',
										command: 'insertIfElse',
										label: 'If and Else'
									},
									{type: 'separator'},
									{
										type: 'button',
										command: 'insertVariable',
										label: 'Variable'
									},
									{
										type: 'button',
										command: 'insertChance',
										label: 'Chance'
									},
									{
										type: 'button',
										command: 'insertDice',
										label: 'Dice'
									}
								]
							},
							{
								type: 'button',
								icon: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='${iconColor}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='icon icon-tabler icons-tabler-outline icon-tabler-brackets'%3E%3Cpath stroke='none' d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M8 4h-3v16h3' /%3E%3Cpath d='M16 4h3v16h-3' /%3E%3C/svg%3E`,
								label: 'Brackets',
								command: 'insertBrackets',
								disabled: !editor.getDoc().somethingSelected()
							}
						];
					},
					mode() {
						return {
							startState() {
								return {choice: false};
							},
							token(stream, state) {
								if (stream.eatSpace()) return null;

								if (stream.match('//')) {
								  stream.skipToEnd();
								  return 'meta';
								}

								if (stream.match('-')) {
									if (stream.skipTo(':')) {
										choice = true;
									}
									else {
										choice = false;
										stream.skipToEnd();
									}
									return 'text';
								}
								if (stream.match(':')) {
									if (choice) {
										stream.skipToEnd();
										choice = false;
										return 'keyword';
									}
									else {
										stream.skipToEnd();
									}
									return 'text';
								}
							
								if (stream.match(/^\[.+?\]/)) {
									return 'keyword';
								}
							
								stream.next();
								return 'text';
							}
						};
					}
				},
				references: {
					parsePassageText(text) {
						const matchers = [/\[move\s*(.+?)\s*]/g, /^-[^:\n]*:\s*([^\n:]*)(?=\s*:|\n|$)/gm];
						const results = [];

						for (const matcher of matchers) {
							let match;
							while ((match = matcher.exec(text))) {
								const action = match[1].match(/(=|\+|-|\*|\/| is | roll | chance )/);
								if (!action) {
									results.push(match[1].trim());
								}
							}
						}
						return results;
					}
				}
			}
		}
	}
});