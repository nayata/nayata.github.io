window.storyFormat({
	name: "Harrow",
	version: "1.0.0",
	description: "Harrow narrative format. See its <a href='https://github.com/nayata' target='_blank'>documentation</a>.",
	author: "Nayata",
	proofing: false,
	source: "<!DOCTYPE html>\r\n<html>\r\n\t<head>\r\n\t\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\r\n\t\t<meta charset=\"utf-8\"/>\r\n\t\t<title>{{STORY_NAME}}</title>\r\n\t\t<style>html{display:grid;height:100%;font-size:100%;font-size:21px}body{font-family:'Helvetica',sans-serif;background:#222;background-image:none;background-position:50% 50%;background-repeat:no-repeat;background-size:cover;scroll-behavior:smooth;overflow:auto}page{min-width:0;min-height:0;width:700px;height:90%;display:grid;grid-template-rows:auto 1fr auto;gap:8x;position:absolute;top:0;bottom:0;left:0;right:0;margin:auto;border-radius:16px;font-size:1rem;color:#333;background:#fafafa;transition:0.6s background ease}page.novel{grid-template-rows:auto auto 1fr auto}page.novel textbox{padding:1em 3em 0}header{padding:2em 3em 1em;color:#555}chapter{float:left}imagebox{display:none;position:relative;padding:0 3em;margin:0 3em;width:auto;height:280px;background:#fff;background-image:none;background-position:50% 50%;background-size:cover;opacity:0}textbox{padding:2em 3em 0;scroll-behavior:smooth;overflow:auto;width:auto}textbox p{line-height:1.5;margin-top:1rem}textbox img{width:100%;height:auto}.speaker{display:none}action{padding:0 3em 2em}choice,button{padding:16px 0;border-style:none;border-radius:10px;font-family:sans-serif;font-weight:500;font-style:normal;font-size:.875em;line-height:1.5;color:#ececec;background-color:#323232;cursor:pointer;display:block;margin:4px auto 0;text-align:center;width:70%}button:hover{background-color:#2e2e2e}.disabled{pointer-events:none;opacity:.9}open,close{display:block;position:absolute;top:2em;right:3em;cursor:pointer;height:20px;width:20px}open{background-image:url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' version='1.1' x='0px' y='0px' fill='currentColor' width='30px' height='30px' viewBox='0 0 30 30' enable-background='new 0 0 30 30' xml:space='preserve'><rect width='30' height='6'/><rect y='24' width='30' height='6'/><rect y='12' width='30' height='6'/></svg>\");background-size:contain;opacity:.75}close{background-image:url(\"data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink' version='1.1' x='0px' y='0px' fill='currentColor' stroke='currentColor' stroke-width='7' width='30px' height='30px' viewBox='0 0 30 30' enable-background='new 0 0 30 30' xml:space='preserve'><line x1='2' y1='2' x2='28' y2='28'/><line x1='28' x2='2' y1='2' y2='28'/></svg>\");background-size:contain;opacity:.75;z-index:-100}settings{width:auto;height:auto;display:none;position:absolute;top:0;bottom:0;left:0;right:0;padding:6em 0 2em;margin:auto;border-radius:16px;background:#fafafa;overflow:auto;font-size:1rem;z-index:-1;opacity:0}settings content{padding:0 3em;scroll-behavior:smooth;overflow:auto}settings p{line-height:1.5;margin-top:1rem}settings .image{display:block;width:auto;height:280px;background-image:none;background-position:50% 50%;background-size:cover}@media screen and (max-width:600px){page{width:100%;height:100%;border-radius:0}header{padding:2em 2em 1em}imagebox{margin:0 2em}textbox{padding:2em 2em 0}action{padding:0 2em 2em}choice,button{width:100%}page.novel textbox{padding:1em 2em 0}open,close{right:2em}settings{border-radius:0}settings content{padding:0 2em}}</style>\r\n\t</head>\r\n\t<body>\r\n\t\t{{STORY_DATA}}\r\n\t\t<transition></transition>\r\n\t\t<page>\r\n\t\t<settings></settings>\r\n\t\t<close></close><open></open>\r\n\t\t<header>\r\n\t\t\t<chapter>Chapter</chapter>\r\n\t\t</header>\r\n\t\t<imagebox></imagebox>\r\n\t\t<textbox></textbox>\r\n\t\t<action>\r\n\t\t\t<dialogue></dialogue>\r\n\t\t\t<button></button>\r\n\t\t</action>\r\n\t\t</page>\r\n\t</body>\r\n\t<script src=\"https://code.jquery.com/jquery-3.1.0.min.js\"></script>\r\n\t<script>\r\n// Generated by Haxe 4.3.4\r\n(function ($hx_exports, $global) { \"use strict\";\r\nfunction $extend(from, fields) {\r\n\tvar proto = Object.create(from);\r\n\tfor (var name in fields) proto[name] = fields[name];\r\n\tif( fields.toString !== Object.prototype.toString ) proto.toString = fields.toString;\r\n\treturn proto;\r\n}\r\nvar App = $hx_exports[\"App\"] = function() {\r\n\tthis.folder = \"\";\r\n\tthis.buffer = \"\";\r\n\tthis.maxlenght = 240;\r\n\tthis.parsespeaker = false;\r\n\tthis.bookmark = [];\r\n\tvar _gthis = this;\r\n\tLibrary.parseSpeaker = true;\r\n\tLogic.random = new Dice();\r\n\tvar storydata = window.document.querySelector(\"tw-storydata\");\r\n\tthis.story = Parser.get(storydata);\r\n\tthis.novel = new Runtime(this.story);\r\n\tthis.novel.onText = $bind(this,this.onText);\r\n\tthis.novel.onDialogue = $bind(this,this.onDialogue);\r\n\tthis.novel.onTransition = $bind(this,this.onTransition);\r\n\tthis.novel.onEvent = $bind(this,this.onEvent);\r\n\tthis.novel.onEnd = $bind(this,this.onEnd);\r\n\tthis.textbox = window.document.querySelector(\"textbox\");\r\n\tthis.dialogue = window.document.querySelector(\"dialogue\");\r\n\tthis.button = window.document.querySelector(\"button\");\r\n\tthis.button.textContent = \"Continue\";\r\n\tthis.button.style.display = \"none\";\r\n\tthis.button.onclick = function(event) {\r\n\t\t_gthis.onClick();\r\n\t};\r\n\twindow.document.querySelector(\"chapter\").innerHTML = storydata.getAttribute(\"name\");\r\n\twindow.document.querySelector(\"close\").onclick = function(event) {\r\n\t\t_gthis.close();\r\n\t};\r\n\twindow.document.querySelector(\"open\").onclick = function(event) {\r\n\t\t_gthis.open(\"Settings\");\r\n\t};\r\n\tvar style = window.document.createElement(\"style\");\r\n\tstyle.innerHTML = window.document.querySelector(\"#twine-user-stylesheet\").innerHTML;\r\n\twindow.document.querySelector(\"body\").appendChild(style);\r\n\tvar script = window.document.createElement(\"script\");\r\n\tscript.innerHTML = window.document.querySelector(\"#twine-user-script\").innerHTML;\r\n\twindow.document.querySelector(\"body\").appendChild(script);\r\n\tthis.novel.nextPage();\r\n};\r\nApp.__name__ = true;\r\nApp.main = function() {\r\n\tApp.ME = new App();\r\n};\r\nApp.prototype = {\r\n\tonClick: function() {\r\n\t\tthis.button.style.display = \"none\";\r\n\t\tthis.novel.nextPage();\r\n\t}\r\n\t,showText: function() {\r\n\t\tthis.textbox.innerHTML = this.buffer;\r\n\t\tthis.buffer = \"\";\r\n\t\tthis.textbox.style.opacity = \"0\";\r\n\t\t$(this.textbox).fadeTo(300,1);\r\n\t}\r\n\t,onText: function(text,name) {\r\n\t\tvar speaker = name != \"\" ? \"<span class = \\\"speaker\\\">\" + name + \"</span>\" : \"\";\r\n\t\tvar element = name != \"\" ? \"<p class = \\\"\" + name + \"\\\">\" : \"<p>\";\r\n\t\tif(!this.parsespeaker && name != \"\") {\r\n\t\t\tspeaker = name + \": \";\r\n\t\t}\r\n\t\tthis.buffer = this.buffer + element + speaker + text + \"</p>\";\r\n\t\tvar ready = this.buffer.length > this.maxlenght;\r\n\t\tvar page = this.novel.story.look(this.novel.story.page + 1);\r\n\t\tvar last = page == null;\r\n\t\tif(last) {\r\n\t\t\tthis.button.style.display = \"block\";\r\n\t\t\tthis.showText();\r\n\t\t}\r\n\t\tif(last) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif(page.type == \"dialogue\" && ready) {\r\n\t\t\tthis.novel.nextPage();\r\n\t\t}\r\n\t\tif(page.type != \"dialogue\" && ready) {\r\n\t\t\tthis.button.style.display = \"block\";\r\n\t\t\tthis.showText();\r\n\t\t}\r\n\t\tif(ready) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif(page.type == \"text\" || page.type == \"dialogue\") {\r\n\t\t\tthis.novel.nextPage();\r\n\t\t} else {\r\n\t\t\tthis.button.style.display = \"block\";\r\n\t\t\tthis.showText();\r\n\t\t}\r\n\t}\r\n\t,onDialogue: function(choices) {\r\n\t\tvar _gthis = this;\r\n\t\tif(this.buffer.length > 0) {\r\n\t\t\tthis.showText();\r\n\t\t}\r\n\t\tvar _g = 0;\r\n\t\twhile(_g < choices.length) {\r\n\t\t\tvar entry = [choices[_g]];\r\n\t\t\t++_g;\r\n\t\t\tvar choice = window.document.createElement(\"choice\");\r\n\t\t\tchoice.setAttribute(\"role\",\"button\");\r\n\t\t\tchoice.innerHTML = this.format(entry[0].text);\r\n\t\t\tif(entry[0].role != \"empty\") {\r\n\t\t\t\tchoice.id = entry[0].role;\r\n\t\t\t}\r\n\t\t\tvar allowed = entry[0].mode == \"empty\" ? true : Logic.condition(entry[0].mode);\r\n\t\t\tif(!allowed) {\r\n\t\t\t\tchoice.className = \"disabled\";\r\n\t\t\t}\r\n\t\t\tchoice.onclick = (function(entry) {\r\n\t\t\t\treturn function(event) {\r\n\t\t\t\t\t_gthis.onSelect(entry[0].type,entry[0].data);\r\n\t\t\t\t};\r\n\t\t\t})(entry);\r\n\t\t\tthis.dialogue.appendChild(choice);\r\n\t\t}\r\n\t}\r\n\t,onSelect: function(type,data) {\r\n\t\tthis.dialogue.innerHTML = \"\";\r\n\t\tthis.textbox.innerHTML = \"\";\r\n\t\tthis.novel.onChoice(type,data);\r\n\t}\r\n\t,onEvent: function(type,data) {\r\n\t\tswitch(type) {\r\n\t\tcase \"config.assets.folder\":\r\n\t\t\tthis.folder = data;\r\n\t\t\tbreak;\r\n\t\tcase \"config.parse.speaker\":\r\n\t\t\tthis.parsespeaker = data == \"true\";\r\n\t\t\tbreak;\r\n\t\tcase \"config.text.maxlenght\":\r\n\t\t\tthis.maxlenght = Std.parseInt(data);\r\n\t\t\tbreak;\r\n\t\tcase \"image\":\r\n\t\t\tthis.imageEvent(data);\r\n\t\t\tbreak;\r\n\t\tcase \"scene\":\r\n\t\t\tthis.sceneEvent(data);\r\n\t\t\tthis.novel.nextPage();\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tthis.screenEvent(type,data);\r\n\t\t}\r\n\t}\r\n\t,sceneEvent: function(data) {\r\n\t\tif(data == \"close\") {\r\n\t\t\tvar page = this.bookmark.pop();\r\n\t\t\tif(page != null) {\r\n\t\t\t\tthis.story.turn(page);\r\n\t\t\t}\r\n\t\t} else if(data == \"clear\") {\r\n\t\t\tthis.bookmark = [];\r\n\t\t} else {\r\n\t\t\tthis.bookmark.push(this.story.page);\r\n\t\t\tthis.story.move(data);\r\n\t\t}\r\n\t}\r\n\t,imageEvent: function(data) {\r\n\t\tvar element = window.document.querySelector(\"imagebox\");\r\n\t\tif(data == \"show\") {\r\n\t\t\twindow.document.querySelector(\"page\").className = \"novel\";\r\n\t\t\telement.style.display = \"block\";\r\n\t\t} else if(data == \"hide\") {\r\n\t\t\twindow.document.querySelector(\"page\").removeAttribute(\"class\");\r\n\t\t\telement.style.display = \"none\";\r\n\t\t} else {\r\n\t\t\twindow.document.querySelector(\"page\").className = \"novel\";\r\n\t\t\telement.style.display = \"block\";\r\n\t\t\tvar tmp = \"url('\" + this.folder + this.decode(data);\r\n\t\t\telement.style.backgroundImage = tmp + \"')\";\r\n\t\t\telement.style.opacity = \"0\";\r\n\t\t\t$(element).fadeTo(300,1);\r\n\t\t}\r\n\t}\r\n\t,screenEvent: function(name,data) {\r\n\t\tvar entry = data.split(\":\");\r\n\t\tvar type = entry.shift();\r\n\t\tvar text = entry.join(\" \");\r\n\t\tvar element = window.document.querySelector(name);\r\n\t\tif(element == null) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\ttext = this.decode(text);\r\n\t\tif(type != null) {\r\n\t\t\tswitch(type) {\r\n\t\t\tcase \"add\":\r\n\t\t\t\tvar item = window.document.createElement(text);\r\n\t\t\t\telement.appendChild(item);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"after\":\r\n\t\t\t\tvar item = window.document.createElement(text);\r\n\t\t\t\telement.parentNode.insertBefore(item,element.nextSibling);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"append\":\r\n\t\t\t\telement.innerHTML += this.format(text);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"before\":\r\n\t\t\t\tvar item = window.document.createElement(text);\r\n\t\t\t\telement.parentNode.insertBefore(item,element);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"class\":\r\n\t\t\t\telement.setAttribute(\"class\",text);\r\n\t\t\t\tif(text == \"default\") {\r\n\t\t\t\t\telement.removeAttribute(\"class\");\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"css\":\r\n\t\t\t\tvar position = text.indexOf(\" \");\r\n\t\t\t\tvar prop = text.substring(0,position);\r\n\t\t\t\tvar data = text.substring(position + 1,text.length);\r\n\t\t\t\telement.style.setProperty(prop,data);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"hide\":\r\n\t\t\t\telement.style.display = \"none\";\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"html\":\r\n\t\t\t\telement.innerHTML = this.format(text);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"id\":\r\n\t\t\t\telement.setAttribute(\"id\",text);\r\n\t\t\t\tif(text == \"default\") {\r\n\t\t\t\t\telement.removeAttribute(\"id\");\r\n\t\t\t\t}\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"image\":\r\n\t\t\t\telement.style.backgroundImage = \"url('\" + this.folder + text + \"')\";\r\n\t\t\t\telement.style.opacity = \"0\";\r\n\t\t\t\t$(element).fadeTo(300,1);\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"onclick\":\r\n\t\t\t\telement.setAttribute(\"onclick\",this.format(text));\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"show\":\r\n\t\t\t\telement.style.display = \"block\";\r\n\t\t\t\tbreak;\r\n\t\t\tcase \"text\":\r\n\t\t\t\telement.textContent = this.format(text);\r\n\t\t\t\tbreak;\r\n\t\t\tdefault:\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t,onTransition: function() {\r\n\t\tvar _gthis = this;\r\n\t\tvar hide = function() {\r\n\t\t\tvar transition = window.document.querySelector(\"transition\");\r\n\t\t\ttransition.style.zIndex = \"-1\";\r\n\t\t};\r\n\t\tvar fade = function() {\r\n\t\t\tvar transition = window.document.querySelector(\"transition\");\r\n\t\t\ttransition.className = \"off\";\r\n\t\t\thaxe_Timer.delay(hide,600);\r\n\t\t\t_gthis.novel.nextPage();\r\n\t\t};\r\n\t\tvar transition = window.document.querySelector(\"transition\");\r\n\t\ttransition.style.zIndex = \"600\";\r\n\t\ttransition.className = \"active\";\r\n\t\thaxe_Timer.delay(fade,900);\r\n\t}\r\n\t,onEnd: function() {\r\n\t\tthis.textbox.innerHTML = \"<p>Story End.</p>\";\r\n\t\t$(this.textbox).fadeTo(300,1);\r\n\t}\r\n\t,open: function(name) {\r\n\t\tvar page = this.story.find(\"route\",name);\r\n\t\tif(page == null) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tvar skip = false;\r\n\t\tvar string = \"\";\r\n\t\t++page;\r\n\t\tvar _g = page;\r\n\t\tvar _g1 = this.story.data.length;\r\n\t\twhile(_g < _g1) {\r\n\t\t\tvar i = _g++;\r\n\t\t\tif(this.story.data[i].type == \"route\") {\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tif(this.story.data[i].type == \"condition\") {\r\n\t\t\t\tif(skip && this.story.data[i].text == \"else\" || skip && this.story.data[i].text == \"end\") {\r\n\t\t\t\t\tskip = false;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tskip = !Logic.condition(this.story.data[i].text);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(skip) {\r\n\t\t\t\tcontinue;\r\n\t\t\t}\r\n\t\t\tif(this.story.data[i].type == \"text\") {\r\n\t\t\t\tvar speaker = this.story.data[i].data;\r\n\t\t\t\tvar element = speaker != \"\" ? \"<p class = \\\"\" + speaker + \"\\\">\" : \"<p>\";\r\n\t\t\t\tstring = string + element + this.story.data[i].text + \"</p>\";\r\n\t\t\t}\r\n\t\t\tif(this.story.data[i].type == \"dialogue\") {\r\n\t\t\t\tvar choices = Dialogue.get(this.story.data[i].text);\r\n\t\t\t\tvar _g2 = 0;\r\n\t\t\t\twhile(_g2 < choices.length) {\r\n\t\t\t\t\tvar choice = choices[_g2];\r\n\t\t\t\t\t++_g2;\r\n\t\t\t\t\tvar element1 = \"<choice id=\\\"\" + choice.mode + \"\\\" onclick=\\\"\" + choice.data + \"\\\">\" + choice.text + \"</choice>\";\r\n\t\t\t\t\tstring += element1;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(this.story.data[i].type == \"event\" && this.story.data[i].data == \"image\") {\r\n\t\t\t\tvar image = this.decode(this.story.data[i].text);\r\n\t\t\t\tvar element2 = \"<p class=\\\"image\\\" style=\\\"background-image: url(\" + this.folder + image + \");\\\"></p>\";\r\n\t\t\t\tstring += element2;\r\n\t\t\t}\r\n\t\t}\r\n\t\twindow.document.querySelector(\"close\").style.zIndex = \"400\";\r\n\t\tvar element = window.document.querySelector(\"settings\");\r\n\t\telement.innerHTML = \"<content>\" + string + \"</content>\";\r\n\t\telement.setAttribute(\"class\",name.toLowerCase());\r\n\t\telement.style.display = \"grid\";\r\n\t\telement.style.zIndex = \"300\";\r\n\t\telement.style.opacity = \"1\";\r\n\t}\r\n\t,close: function() {\r\n\t\twindow.document.querySelector(\"close\").style.zIndex = \"-1\";\r\n\t\tvar element = window.document.querySelector(\"settings\");\r\n\t\telement.removeAttribute(\"class\");\r\n\t\telement.style.display = \"none\";\r\n\t\telement.style.opacity = \"0\";\r\n\t\telement.style.zIndex = \"-1\";\r\n\t}\r\n\t,decode: function(entry) {\r\n\t\tentry = StringTools.replace(entry,\"https \",\"https:\");\r\n\t\tentry = StringTools.replace(entry,\"http \",\"http:\");\r\n\t\treturn entry;\r\n\t}\r\n\t,format: function(entry) {\r\n\t\tif(entry.indexOf(\"$\") == -1) {\r\n\t\t\treturn entry;\r\n\t\t}\r\n\t\tvar rex = new EReg(\"\\\\$\\\\S+?(?=[^a-zA-Z.]|$)\",\"g\");\r\n\t\tentry = rex.map(entry,function(r) {\r\n\t\t\tvar matching = r.matched(0);\r\n\t\t\tvar variable = matching.substring(1,matching.length);\r\n\t\t\tif(Storage.has(variable)) {\r\n\t\t\t\treturn Storage.get(variable);\r\n\t\t\t}\r\n\t\t\treturn matching;\r\n\t\t});\r\n\t\treturn entry;\r\n\t}\r\n};\r\nvar Random = function() {\r\n};\r\nRandom.__name__ = true;\r\nRandom.prototype = {\r\n\tchance: function(entry) {\r\n\t\treturn this.roll(0,100) < Std.parseInt(entry);\r\n\t}\r\n\t,dice: function(entry) {\r\n\t\treturn this.roll(1,Std.parseInt(entry));\r\n\t}\r\n\t,roll: function(min,max) {\r\n\t\treturn min + Math.floor((max - min + 1) * Math.random());\r\n\t}\r\n};\r\nvar Dice = function() {\r\n\tRandom.call(this);\r\n};\r\nDice.__name__ = true;\r\nDice.__super__ = Random;\r\nDice.prototype = $extend(Random.prototype,{\r\n\tchance: function(entry) {\r\n\t\treturn this.roll(0,100) < Std.parseInt(entry);\r\n\t}\r\n\t,dice: function(entry) {\r\n\t\tvar text = entry.toLowerCase();\r\n\t\tvar keys = text.split(\"d\");\r\n\t\tif(keys.length == 1) {\r\n\t\t\treturn this.roll(1,Std.parseInt(text));\r\n\t\t}\r\n\t\tvar pool = Std.parseInt(keys.shift());\r\n\t\tvar side = keys.shift();\r\n\t\tvar type = side.charAt(side.length - 1);\r\n\t\tif(type == \"h\" || type == \"l\") {\r\n\t\t\tside = side.substring(0,side.length - 1);\r\n\t\t}\r\n\t\tvar rolls = [];\r\n\t\tvar total = 0;\r\n\t\tvar _g = 0;\r\n\t\tvar _g1 = pool;\r\n\t\twhile(_g < _g1) {\r\n\t\t\tvar i = _g++;\r\n\t\t\tvar take = this.roll(1,Std.parseInt(side));\r\n\t\t\ttotal += take;\r\n\t\t\trolls.push(take);\r\n\t\t}\r\n\t\trolls.sort(function(a,b) {\r\n\t\t\treturn a - b;\r\n\t\t});\r\n\t\tif(type == \"l\") {\r\n\t\t\treturn rolls.shift();\r\n\t\t}\r\n\t\tif(type == \"h\") {\r\n\t\t\treturn rolls.pop();\r\n\t\t}\r\n\t\treturn total;\r\n\t}\r\n});\r\nvar EReg = function(r,opt) {\r\n\tthis.r = new RegExp(r,opt.split(\"u\").join(\"\"));\r\n};\r\nEReg.__name__ = true;\r\nEReg.prototype = {\r\n\tmatch: function(s) {\r\n\t\tif(this.r.global) {\r\n\t\t\tthis.r.lastIndex = 0;\r\n\t\t}\r\n\t\tthis.r.m = this.r.exec(s);\r\n\t\tthis.r.s = s;\r\n\t\treturn this.r.m != null;\r\n\t}\r\n\t,matched: function(n) {\r\n\t\tif(this.r.m != null && n >= 0 && n < this.r.m.length) {\r\n\t\t\treturn this.r.m[n];\r\n\t\t} else {\r\n\t\t\tthrow haxe_Exception.thrown(\"EReg::matched\");\r\n\t\t}\r\n\t}\r\n\t,matchedPos: function() {\r\n\t\tif(this.r.m == null) {\r\n\t\t\tthrow haxe_Exception.thrown(\"No string matched\");\r\n\t\t}\r\n\t\treturn { pos : this.r.m.index, len : this.r.m[0].length};\r\n\t}\r\n\t,matchSub: function(s,pos,len) {\r\n\t\tif(len == null) {\r\n\t\t\tlen = -1;\r\n\t\t}\r\n\t\tif(this.r.global) {\r\n\t\t\tthis.r.lastIndex = pos;\r\n\t\t\tthis.r.m = this.r.exec(len < 0 ? s : HxOverrides.substr(s,0,pos + len));\r\n\t\t\tvar b = this.r.m != null;\r\n\t\t\tif(b) {\r\n\t\t\t\tthis.r.s = s;\r\n\t\t\t}\r\n\t\t\treturn b;\r\n\t\t} else {\r\n\t\t\tvar b = this.match(len < 0 ? HxOverrides.substr(s,pos,null) : HxOverrides.substr(s,pos,len));\r\n\t\t\tif(b) {\r\n\t\t\t\tthis.r.s = s;\r\n\t\t\t\tthis.r.m.index += pos;\r\n\t\t\t}\r\n\t\t\treturn b;\r\n\t\t}\r\n\t}\r\n\t,map: function(s,f) {\r\n\t\tvar offset = 0;\r\n\t\tvar buf_b = \"\";\r\n\t\tdo {\r\n\t\t\tif(offset >= s.length) {\r\n\t\t\t\tbreak;\r\n\t\t\t} else if(!this.matchSub(s,offset)) {\r\n\t\t\t\tbuf_b += Std.string(HxOverrides.substr(s,offset,null));\r\n\t\t\t\tbreak;\r\n\t\t\t}\r\n\t\t\tvar p = this.matchedPos();\r\n\t\t\tbuf_b += Std.string(HxOverrides.substr(s,offset,p.pos - offset));\r\n\t\t\tbuf_b += Std.string(f(this));\r\n\t\t\tif(p.len == 0) {\r\n\t\t\t\tbuf_b += Std.string(HxOverrides.substr(s,p.pos,1));\r\n\t\t\t\toffset = p.pos + 1;\r\n\t\t\t} else {\r\n\t\t\t\toffset = p.pos + p.len;\r\n\t\t\t}\r\n\t\t} while(this.r.global);\r\n\t\tif(!this.r.global && offset > 0 && offset < s.length) {\r\n\t\t\tbuf_b += Std.string(HxOverrides.substr(s,offset,null));\r\n\t\t}\r\n\t\treturn buf_b;\r\n\t}\r\n};\r\nvar HxOverrides = function() { };\r\nHxOverrides.__name__ = true;\r\nHxOverrides.cca = function(s,index) {\r\n\tvar x = s.charCodeAt(index);\r\n\tif(x != x) {\r\n\t\treturn undefined;\r\n\t}\r\n\treturn x;\r\n};\r\nHxOverrides.substr = function(s,pos,len) {\r\n\tif(len == null) {\r\n\t\tlen = s.length;\r\n\t} else if(len < 0) {\r\n\t\tif(pos == 0) {\r\n\t\t\tlen = s.length + len;\r\n\t\t} else {\r\n\t\t\treturn \"\";\r\n\t\t}\r\n\t}\r\n\treturn s.substr(pos,len);\r\n};\r\nHxOverrides.now = function() {\r\n\treturn Date.now();\r\n};\r\nMath.__name__ = true;\r\nvar Parser = function() { };\r\nParser.__name__ = true;\r\nParser.get = function(storydata) {\r\n\tvar entry = \"\";\r\n\tvar start = \"\";\r\n\tvar startnode = storydata.getAttribute(\"startnode\");\r\n\tvar passages = storydata.children;\r\n\tvar _g = 0;\r\n\twhile(_g < passages.length) {\r\n\t\tvar passage = passages[_g];\r\n\t\t++_g;\r\n\t\tvar name = passage.getAttribute(\"name\");\r\n\t\tvar pid = passage.getAttribute(\"pid\");\r\n\t\tif(name != null) {\r\n\t\t\tentry += \"#\" + name + \"\\n\";\r\n\t\t\tif(pid == startnode) {\r\n\t\t\t\tstart = name;\r\n\t\t\t}\r\n\t\t\tvar content = passage.innerHTML.split(\"\\n\");\r\n\t\t\tvar _g1 = 0;\r\n\t\t\twhile(_g1 < content.length) {\r\n\t\t\t\tvar line = content[_g1];\r\n\t\t\t\t++_g1;\r\n\t\t\t\tvar string = StringTools.trim(line);\r\n\t\t\t\tvar lead = string.substring(0,1);\r\n\t\t\t\tvar link = string.substring(0,2);\r\n\t\t\t\tif(lead == \"-\") {\r\n\t\t\t\t\tstring = StringTools.replace(string,\"[[\",\"\");\r\n\t\t\t\t\tstring = StringTools.replace(string,\"]]\",\"\");\r\n\t\t\t\t}\r\n\t\t\t\tif(link == \"[[\") {\r\n\t\t\t\t\tstring = StringTools.replace(string,\"[[\",\"\");\r\n\t\t\t\t\tstring = StringTools.replace(string,\"]]\",\"\");\r\n\t\t\t\t\tstring = \"[move \" + string + \"]\";\r\n\t\t\t\t}\r\n\t\t\t\tstring = StringTools.replace(string,\"&lt;\",\"<\");\r\n\t\t\t\tstring = StringTools.replace(string,\"&gt;\",\">\");\r\n\t\t\t\tentry += string + \"\\n\";\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tvar story = Library.get(entry);\r\n\tstory.move(start);\r\n\treturn story;\r\n};\r\nvar Std = function() { };\r\nStd.__name__ = true;\r\nStd.string = function(s) {\r\n\treturn js_Boot.__string_rec(s,\"\");\r\n};\r\nStd.parseInt = function(x) {\r\n\tvar v = parseInt(x);\r\n\tif(isNaN(v)) {\r\n\t\treturn null;\r\n\t}\r\n\treturn v;\r\n};\r\nvar StringTools = function() { };\r\nStringTools.__name__ = true;\r\nStringTools.isSpace = function(s,pos) {\r\n\tvar c = HxOverrides.cca(s,pos);\r\n\tif(!(c > 8 && c < 14)) {\r\n\t\treturn c == 32;\r\n\t} else {\r\n\t\treturn true;\r\n\t}\r\n};\r\nStringTools.ltrim = function(s) {\r\n\tvar l = s.length;\r\n\tvar r = 0;\r\n\twhile(r < l && StringTools.isSpace(s,r)) ++r;\r\n\tif(r > 0) {\r\n\t\treturn HxOverrides.substr(s,r,l - r);\r\n\t} else {\r\n\t\treturn s;\r\n\t}\r\n};\r\nStringTools.rtrim = function(s) {\r\n\tvar l = s.length;\r\n\tvar r = 0;\r\n\twhile(r < l && StringTools.isSpace(s,l - r - 1)) ++r;\r\n\tif(r > 0) {\r\n\t\treturn HxOverrides.substr(s,0,l - r);\r\n\t} else {\r\n\t\treturn s;\r\n\t}\r\n};\r\nStringTools.trim = function(s) {\r\n\treturn StringTools.ltrim(StringTools.rtrim(s));\r\n};\r\nStringTools.replace = function(s,sub,by) {\r\n\treturn s.split(sub).join(by);\r\n};\r\nvar Choice = function() {\r\n\tthis.role = \"empty\";\r\n\tthis.mode = \"empty\";\r\n\tthis.data = \"empty\";\r\n\tthis.text = \"empty\";\r\n\tthis.type = \"empty\";\r\n};\r\nChoice.__name__ = true;\r\nvar Dialogue = function() { };\r\nDialogue.__name__ = true;\r\nDialogue.get = function(entry) {\r\n\tvar map = entry.split(Library.LINE);\r\n\tvar choices = [];\r\n\tvar _g = 0;\r\n\tvar _g1 = map.length;\r\n\twhile(_g < _g1) {\r\n\t\tvar i = _g++;\r\n\t\tvar key = map[i].split(Library.ITEM);\r\n\t\tvar choice = new Choice();\r\n\t\tchoice.text = key[0];\r\n\t\tchoice.type = key[1];\r\n\t\tchoice.data = key[2];\r\n\t\tchoice.mode = key[3];\r\n\t\tchoice.role = key[4];\r\n\t\tchoices.push(choice);\r\n\t}\r\n\treturn choices;\r\n};\r\nvar Format = function() { };\r\nFormat.__name__ = true;\r\nFormat.variable = function(entry) {\r\n\tif(entry.indexOf(\"[\") == -1) {\r\n\t\treturn entry;\r\n\t}\r\n\tvar rex = new EReg(\"\\\\[(.*?)\\\\]\",\"gi\");\r\n\tentry = rex.map(entry,function(r) {\r\n\t\tvar matching = r.matched(0);\r\n\t\tvar variable = matching.substring(1,matching.length - 1);\r\n\t\tif(Storage.has(variable)) {\r\n\t\t\treturn Storage.get(variable);\r\n\t\t}\r\n\t\treturn matching;\r\n\t});\r\n\treturn entry;\r\n};\r\nvar Library = function() { };\r\nLibrary.__name__ = true;\r\nLibrary.get = function(entry) {\r\n\tvar res = entry.split(Library.LF);\r\n\tvar story = new Story();\r\n\tvar line = 0;\r\n\twhile(line < res.length) {\r\n\t\tvar node = Library.getNode(res,line);\r\n\t\tif(node != null && node.type != Library.EMPTY) {\r\n\t\t\tvar page = new Page();\r\n\t\t\tpage.type = node.type;\r\n\t\t\tpage.text = node.text;\r\n\t\t\tpage.data = node.data;\r\n\t\t\tstory.data.push(page);\r\n\t\t\tline += node.depth;\r\n\t\t}\r\n\t\t++line;\r\n\t}\r\n\treturn story;\r\n};\r\nLibrary.getNode = function(res,page) {\r\n\tvar string = StringTools.trim(res[page]);\r\n\tif(string.length == 0) {\r\n\t\treturn null;\r\n\t}\r\n\tvar node = new Node();\r\n\tvar type = \"text\";\r\n\tvar leading = string.substring(0,1);\r\n\tif(leading == \"#\") {\r\n\t\ttype = \"route\";\r\n\t}\r\n\tif(leading == \"-\") {\r\n\t\ttype = \"dialogue\";\r\n\t}\r\n\tif(leading == \"[\") {\r\n\t\ttype = Library.isEvent(string);\r\n\t}\r\n\tif(leading == \"/\") {\r\n\t\ttype = Library.EMPTY;\r\n\t}\r\n\tif(Library.isBreak(string)) {\r\n\t\ttype = \"break\";\r\n\t}\r\n\tnode.type = type;\r\n\tif(type == \"text\") {\r\n\t\tLibrary.getText(node,string);\r\n\t}\r\n\tif(type == \"route\") {\r\n\t\tvar route = StringTools.replace(string,\"#\",\"\");\r\n\t\tnode.text = StringTools.trim(route);\r\n\t}\r\n\tif(type == \"dialogue\") {\r\n\t\tLibrary.getDialogue(node,res,page);\r\n\t}\r\n\tif(type == \"event\") {\r\n\t\tLibrary.getEvent(node,string);\r\n\t}\r\n\treturn node;\r\n};\r\nLibrary.getText = function(node,res) {\r\n\tvar raw = StringTools.replace(res,Library.COLON,Library.LINE);\r\n\tvar key = raw.split(Library.KEY);\r\n\tnode.text = StringTools.trim(key.pop());\r\n\tnode.text = StringTools.replace(node.text,Library.LINE,Library.KEY);\r\n\tnode.data = key.length > 0 ? StringTools.trim(key[Library.TYPE]) : \"\";\r\n\tif(!Library.parseSpeaker) {\r\n\t\tnode.text = res;\r\n\t}\r\n};\r\nLibrary.getDialogue = function(node,res,indent) {\r\n\tvar dialogue = [];\r\n\tvar _g = indent;\r\n\tvar _g1 = res.length;\r\n\twhile(_g < _g1) {\r\n\t\tvar page = _g++;\r\n\t\tvar sampled = StringTools.trim(res[page]);\r\n\t\tvar allowed = sampled.substring(0,2) != Library.DASH + Library.DASH;\r\n\t\tvar leading = sampled.substring(0,1);\r\n\t\tif(leading == Library.DASH && allowed) {\r\n\t\t\tdialogue.push(res[page]);\r\n\t\t} else {\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\tvar content = \"\";\r\n\tvar string = \"\";\r\n\tvar _g = 0;\r\n\tvar _g1 = dialogue.length;\r\n\twhile(_g < _g1) {\r\n\t\tvar i = _g++;\r\n\t\tstring = dialogue[i];\r\n\t\tstring = StringTools.replace(string,Library.DASH,\"\");\r\n\t\tstring = Library.getDialogueItem(string);\r\n\t\tvar divider = Library.LINE;\r\n\t\tif(i == dialogue.length - 1) {\r\n\t\t\tdivider = \"\";\r\n\t\t}\r\n\t\tcontent = content + string + divider;\r\n\t}\r\n\tnode.text = content;\r\n\tnode.data = dialogue.length == 1 ? \"button\" : \"dialogue\";\r\n\tnode.depth = dialogue.length - 1;\r\n};\r\nLibrary.getDialogueItem = function(res) {\r\n\tvar key = res.split(Library.KEY);\r\n\tvar text = StringTools.trim(key[Library.TYPE]);\r\n\tvar type = \"empty\";\r\n\tvar data = \"empty\";\r\n\tvar mode = \"empty\";\r\n\tvar role = \"empty\";\r\n\tif(key.length > 1) {\r\n\t\tvar string = StringTools.trim(key[Library.TEXT]);\r\n\t\tstring = StringTools.replace(string,Library.SPACE,Library.KEY);\r\n\t\tvar prop = string.split(Library.KEY);\r\n\t\tif(Library.isVariable(prop[Library.TEXT])) {\r\n\t\t\ttype = \"variable\";\r\n\t\t\tdata = string;\r\n\t\t} else {\r\n\t\t\ttype = \"route\";\r\n\t\t\tdata = StringTools.trim(key[Library.TEXT]);\r\n\t\t}\r\n\t}\r\n\tif(key.length > 2) {\r\n\t\tmode = StringTools.trim(key[Library.DATA]);\r\n\t\tmode = StringTools.replace(mode,Library.SPACE,Library.KEY);\r\n\t}\r\n\tif(key.length > 3) {\r\n\t\trole = StringTools.trim(key[Library.PROP]);\r\n\t\trole = StringTools.replace(role,Library.SPACE,Library.KEY);\r\n\t}\r\n\treturn text + Library.ITEM + type + Library.ITEM + data + Library.ITEM + mode + Library.ITEM + role;\r\n};\r\nLibrary.getEvent = function(node,res) {\r\n\tvar string = res.substring(1,res.length - 1);\r\n\tstring = StringTools.trim(string);\r\n\tstring = StringTools.replace(string,Library.COMA + Library.SPACE,Library.COMA);\r\n\tstring = StringTools.replace(string,Library.SPACE + Library.SPACE,Library.KEY);\r\n\tstring = StringTools.replace(string,Library.SPACE,Library.KEY);\r\n\tvar key = string.split(Library.KEY);\r\n\tvar type = key[Library.TYPE];\r\n\tnode.type = \"event\";\r\n\tnode.text = StringTools.replace(string,type + \":\",\"\");\r\n\tnode.data = type;\r\n\tif(type == \"move\") {\r\n\t\tnode.type = \"move\";\r\n\t\tnode.text = StringTools.replace(string,\"move:\",\"\");\r\n\t\tnode.text = StringTools.replace(node.text,Library.KEY,Library.SPACE);\r\n\t}\r\n\tif(type == \"story\") {\r\n\t\tnode.type = \"move\";\r\n\t\tnode.text = StringTools.replace(string,\"story:\",\"\");\r\n\t\tnode.text = StringTools.replace(node.text,Library.KEY,Library.SPACE);\r\n\t}\r\n\tif(type == \"lock\" || type == \"close\") {\r\n\t\tnode.type = \"move\";\r\n\t\tnode.text = type;\r\n\t}\r\n\tif(type == \"if\") {\r\n\t\tnode.type = \"condition\";\r\n\t\tnode.text = StringTools.replace(string,\"if:\",\"\");\r\n\t}\r\n\tif(type == \"else\" || type == \"end\") {\r\n\t\tnode.type = \"condition\";\r\n\t\tnode.text = type;\r\n\t}\r\n\tif(Library.isVariable(key[Library.TEXT])) {\r\n\t\tnode.type = \"variable\";\r\n\t\tnode.text = string;\r\n\t}\r\n};\r\nLibrary.isBreak = function(entry) {\r\n\tvar leading = entry.substring(0,2);\r\n\tif(leading == Library.DASH + Library.DASH) {\r\n\t\treturn true;\r\n\t}\r\n\treturn false;\r\n};\r\nLibrary.isEvent = function(entry) {\r\n\tif(entry.indexOf(\"]\") != entry.length - 1) {\r\n\t\treturn \"text\";\r\n\t}\r\n\treturn \"event\";\r\n};\r\nLibrary.isVariable = function(entry) {\r\n\tif(entry == \"=\" || entry == \"+\" || entry == \"-\" || entry == \"*\" || entry == \"/\") {\r\n\t\treturn true;\r\n\t}\r\n\tif(entry == \"is\" || entry == \"roll\" || entry == \"chance\") {\r\n\t\treturn true;\r\n\t}\r\n\treturn false;\r\n};\r\nvar Node = function() {\r\n\tthis.depth = 0;\r\n\tthis.data = \"\";\r\n\tthis.text = \"\";\r\n\tthis.type = \"\";\r\n};\r\nNode.__name__ = true;\r\nvar Logic = function() { };\r\nLogic.__name__ = true;\r\nLogic.variable = function(entry) {\r\n\tvar key = entry.split(Library.KEY);\r\n\tvar name = key.shift();\r\n\tvar type = key.shift();\r\n\tvar prop = key.join(Library.SPACE);\r\n\tif(type != null) {\r\n\t\tswitch(type) {\r\n\t\tcase \"*\":\r\n\t\t\tvar a = parseFloat(Logic.get(name));\r\n\t\t\tvar b = parseFloat(Logic.get(prop));\r\n\t\t\tLogic.set(name,Std.string(a * b));\r\n\t\t\tbreak;\r\n\t\tcase \"+\":\r\n\t\t\tvar a = parseFloat(Logic.get(name));\r\n\t\t\tvar b = parseFloat(Logic.get(prop));\r\n\t\t\tLogic.set(name,Std.string(a + b));\r\n\t\t\tbreak;\r\n\t\tcase \"-\":\r\n\t\t\tvar a = parseFloat(Logic.get(name));\r\n\t\t\tvar b = parseFloat(Logic.get(prop));\r\n\t\t\tLogic.set(name,Std.string(a - b));\r\n\t\t\tbreak;\r\n\t\tcase \"/\":\r\n\t\t\tvar a = parseFloat(Logic.get(name));\r\n\t\t\tvar b = parseFloat(Logic.get(prop));\r\n\t\t\tLogic.set(name,Std.string(a / b));\r\n\t\t\tbreak;\r\n\t\tcase \"=\":\r\n\t\t\tLogic.set(name,Logic.get(prop));\r\n\t\t\tbreak;\r\n\t\tcase \"chance\":\r\n\t\t\tvar prob = Logic.random.chance(Logic.get(prop));\r\n\t\t\tLogic.set(name,prob == null ? \"null\" : \"\" + prob);\r\n\t\t\tbreak;\r\n\t\tcase \"roll\":\r\n\t\t\tvar roll = Logic.random.dice(Logic.get(prop));\r\n\t\t\tLogic.set(name,roll == null ? \"null\" : \"\" + roll);\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t}\r\n\t}\r\n};\r\nLogic.condition = function(entry) {\r\n\tif(entry == \"else\") {\r\n\t\treturn false;\r\n\t}\r\n\tif(entry == \"end\") {\r\n\t\treturn true;\r\n\t}\r\n\tvar key = entry.split(Library.KEY);\r\n\tvar name = key.shift();\r\n\tvar type = key.shift();\r\n\tvar prop = key.join(Library.SPACE);\r\n\tvar result = false;\r\n\tif(type != null) {\r\n\t\tswitch(type) {\r\n\t\tcase \"<\":\r\n\t\t\tvar a = parseFloat(Logic.get(name));\r\n\t\t\tvar b = parseFloat(Logic.get(prop));\r\n\t\t\tresult = a < b;\r\n\t\t\tbreak;\r\n\t\tcase \"=\":\r\n\t\t\tresult = Logic.get(name) == Logic.get(prop);\r\n\t\t\tbreak;\r\n\t\tcase \">\":\r\n\t\t\tvar a = parseFloat(Logic.get(name));\r\n\t\t\tvar b = parseFloat(Logic.get(prop));\r\n\t\t\tresult = a > b;\r\n\t\t\tbreak;\r\n\t\tcase \"chance\":\r\n\t\t\tresult = Logic.random.chance(Logic.get(prop));\r\n\t\t\tbreak;\r\n\t\tcase \"is\":\r\n\t\t\tresult = Logic.get(name) == Logic.get(prop);\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t}\r\n\t}\r\n\treturn result;\r\n};\r\nLogic.get = function(entry) {\r\n\tif(entry == \"false\" || entry == \"true\") {\r\n\t\treturn entry;\r\n\t}\r\n\tif(Storage.has(entry)) {\r\n\t\treturn Storage.get(entry);\r\n\t}\r\n\treturn entry;\r\n};\r\nLogic.set = function(entry,value) {\r\n\tStorage.set(entry,value);\r\n};\r\nvar Page = function() {\r\n\tthis.data = \"\";\r\n\tthis.text = \"\";\r\n\tthis.type = \"\";\r\n};\r\nPage.__name__ = true;\r\nvar Runtime = function(entry) {\r\n\tthis.story = entry;\r\n};\r\nRuntime.__name__ = true;\r\nRuntime.prototype = {\r\n\tnextPage: function() {\r\n\t\tif(this.story.get_end()) {\r\n\t\t\tthis.onEnd();\r\n\t\t}\r\n\t\tif(this.story.get_end()) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tthis.page = this.story.next();\r\n\t\tthis.onPage(this.page);\r\n\t\tswitch(this.page.type) {\r\n\t\tcase \"break\":\r\n\t\t\tthis.nextPage();\r\n\t\t\tbreak;\r\n\t\tcase \"condition\":\r\n\t\t\tvar condition = Logic.condition(this.page.text);\r\n\t\t\tif(condition == false) {\r\n\t\t\t\tthis.story.skip();\r\n\t\t\t}\r\n\t\t\tthis.nextPage();\r\n\t\t\tbreak;\r\n\t\tcase \"dialogue\":\r\n\t\t\tvar dialogue = Dialogue.get(this.page.text);\r\n\t\t\tvar _g = 0;\r\n\t\t\twhile(_g < dialogue.length) {\r\n\t\t\t\tvar choice = dialogue[_g];\r\n\t\t\t\t++_g;\r\n\t\t\t\tchoice.text = Format.variable(choice.text);\r\n\t\t\t}\r\n\t\t\tthis.onDialogue(dialogue);\r\n\t\t\tbreak;\r\n\t\tcase \"event\":\r\n\t\t\tthis.gameEvent();\r\n\t\t\tbreak;\r\n\t\tcase \"move\":\r\n\t\t\tif(this.page.data == \"story\") {\r\n\t\t\t\tthis.onStory(this.page.text);\r\n\t\t\t}\r\n\t\t\tif(this.page.data == \"close\") {\r\n\t\t\t\tthis.onClose();\r\n\t\t\t}\r\n\t\t\tif(this.page.data == \"move\") {\r\n\t\t\t\tthis.story.move(this.page.text);\r\n\t\t\t\tthis.nextPage();\r\n\t\t\t}\r\n\t\t\tbreak;\r\n\t\tcase \"route\":\r\n\t\t\tbreak;\r\n\t\tcase \"text\":\r\n\t\t\tvar text = Format.variable(this.page.text);\r\n\t\t\tthis.onText(text,this.page.data);\r\n\t\t\tbreak;\r\n\t\tcase \"variable\":\r\n\t\t\tLogic.variable(this.page.text);\r\n\t\t\tthis.nextPage();\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t}\r\n\t}\r\n\t,gameEvent: function() {\r\n\t\tswitch(this.page.data) {\r\n\t\tcase \"scene\":\r\n\t\t\tthis.onEvent(this.page.data,this.page.text);\r\n\t\t\tbreak;\r\n\t\tcase \"transition\":\r\n\t\t\tthis.onTransition();\r\n\t\t\tbreak;\r\n\t\tcase \"wait\":\r\n\t\t\tvar time = Std.parseInt(this.page.text);\r\n\t\t\thaxe_Timer.delay($bind(this,this.nextPage),time * 60);\r\n\t\t\tbreak;\r\n\t\tdefault:\r\n\t\t\tthis.onEvent(this.page.data,this.page.text);\r\n\t\t\tthis.nextPage();\r\n\t\t}\r\n\t}\r\n\t,onChoice: function(type,data) {\r\n\t\tif(type == \"route\") {\r\n\t\t\tthis.story.move(data);\r\n\t\t}\r\n\t\tif(type == \"variable\") {\r\n\t\t\tLogic.variable(data);\r\n\t\t}\r\n\t\tthis.nextPage();\r\n\t}\r\n\t,onPage: function(page) {\r\n\t}\r\n\t,onText: function(text,name) {\r\n\t}\r\n\t,onDialogue: function(dialogue) {\r\n\t}\r\n\t,onEvent: function(type,data) {\r\n\t}\r\n\t,onTransition: function() {\r\n\t}\r\n\t,onStory: function(name) {\r\n\t}\r\n\t,onClose: function() {\r\n\t}\r\n\t,onEnd: function() {\r\n\t}\r\n};\r\nvar haxe_ds_StringMap = function() {\r\n\tthis.h = Object.create(null);\r\n};\r\nhaxe_ds_StringMap.__name__ = true;\r\nvar Storage = function() { };\r\nStorage.__name__ = true;\r\nStorage.get = function(key) {\r\n\treturn Storage.variable.h[key];\r\n};\r\nStorage.set = function(key,value) {\r\n\tStorage.variable.h[key] = value;\r\n};\r\nStorage.has = function(key) {\r\n\treturn Object.prototype.hasOwnProperty.call(Storage.variable.h,key);\r\n};\r\nvar Story = function() {\r\n\tthis.page = -1;\r\n\tthis.data = [];\r\n};\r\nStory.__name__ = true;\r\nStory.prototype = {\r\n\tnext: function() {\r\n\t\tif(this.page < this.data.length) {\r\n\t\t\tthis.page += 1;\r\n\t\t}\r\n\t\treturn this.data[this.page];\r\n\t}\r\n\t,move: function(route) {\r\n\t\tvar _g = 0;\r\n\t\tvar _g1 = this.data.length;\r\n\t\twhile(_g < _g1) {\r\n\t\t\tvar i = _g++;\r\n\t\t\tif(this.data[i].type == \"route\" && this.data[i].text == route) {\r\n\t\t\t\treturn this.page = i;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn this.page;\r\n\t}\r\n\t,skip: function() {\r\n\t\tvar position = this.page + 1;\r\n\t\tvar _g = position;\r\n\t\tvar _g1 = this.data.length;\r\n\t\twhile(_g < _g1) {\r\n\t\t\tvar i = _g++;\r\n\t\t\tif(this.data[i].type == \"condition\") {\r\n\t\t\t\tif(this.data[i].text == \"end\" || this.data[i].text == \"else\") {\r\n\t\t\t\t\treturn this.page = i;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn this.page;\r\n\t}\r\n\t,turn: function(number) {\r\n\t\tif(number < 0 || number > this.data.length - 1) {\r\n\t\t\treturn this.page;\r\n\t\t}\r\n\t\treturn this.page = number;\r\n\t}\r\n\t,look: function(number) {\r\n\t\tif(number < 0 || number > this.data.length - 1) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\t\treturn this.data[number];\r\n\t}\r\n\t,find: function(type,text) {\r\n\t\tvar _g = 0;\r\n\t\tvar _g1 = this.data.length;\r\n\t\twhile(_g < _g1) {\r\n\t\t\tvar i = _g++;\r\n\t\t\tif(this.data[i].type == type && this.data[i].text == text) {\r\n\t\t\t\treturn i;\r\n\t\t\t}\r\n\t\t\tif(text == \"any\" && this.data[i].type == type) {\r\n\t\t\t\treturn i;\r\n\t\t\t}\r\n\t\t\tif(type == \"any\" && this.data[i].text == text) {\r\n\t\t\t\treturn i;\r\n\t\t\t}\r\n\t\t}\r\n\t\treturn null;\r\n\t}\r\n\t,get_end: function() {\r\n\t\treturn this.page == this.data.length - 1;\r\n\t}\r\n};\r\nvar haxe_Exception = function(message,previous,native) {\r\n\tError.call(this,message);\r\n\tthis.message = message;\r\n\tthis.__previousException = previous;\r\n\tthis.__nativeException = native != null ? native : this;\r\n};\r\nhaxe_Exception.__name__ = true;\r\nhaxe_Exception.thrown = function(value) {\r\n\tif(((value) instanceof haxe_Exception)) {\r\n\t\treturn value.get_native();\r\n\t} else if(((value) instanceof Error)) {\r\n\t\treturn value;\r\n\t} else {\r\n\t\tvar e = new haxe_ValueException(value);\r\n\t\treturn e;\r\n\t}\r\n};\r\nhaxe_Exception.__super__ = Error;\r\nhaxe_Exception.prototype = $extend(Error.prototype,{\r\n\tget_native: function() {\r\n\t\treturn this.__nativeException;\r\n\t}\r\n});\r\nvar haxe_Timer = function(time_ms) {\r\n\tvar me = this;\r\n\tthis.id = setInterval(function() {\r\n\t\tme.run();\r\n\t},time_ms);\r\n};\r\nhaxe_Timer.__name__ = true;\r\nhaxe_Timer.delay = function(f,time_ms) {\r\n\tvar t = new haxe_Timer(time_ms);\r\n\tt.run = function() {\r\n\t\tt.stop();\r\n\t\tf();\r\n\t};\r\n\treturn t;\r\n};\r\nhaxe_Timer.prototype = {\r\n\tstop: function() {\r\n\t\tif(this.id == null) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tclearInterval(this.id);\r\n\t\tthis.id = null;\r\n\t}\r\n\t,run: function() {\r\n\t}\r\n};\r\nvar haxe_ValueException = function(value,previous,native) {\r\n\thaxe_Exception.call(this,String(value),previous,native);\r\n\tthis.value = value;\r\n};\r\nhaxe_ValueException.__name__ = true;\r\nhaxe_ValueException.__super__ = haxe_Exception;\r\nhaxe_ValueException.prototype = $extend(haxe_Exception.prototype,{\r\n});\r\nvar haxe_iterators_ArrayIterator = function(array) {\r\n\tthis.current = 0;\r\n\tthis.array = array;\r\n};\r\nhaxe_iterators_ArrayIterator.__name__ = true;\r\nhaxe_iterators_ArrayIterator.prototype = {\r\n\thasNext: function() {\r\n\t\treturn this.current < this.array.length;\r\n\t}\r\n\t,next: function() {\r\n\t\treturn this.array[this.current++];\r\n\t}\r\n};\r\nvar js_Boot = function() { };\r\njs_Boot.__name__ = true;\r\njs_Boot.__string_rec = function(o,s) {\r\n\tif(o == null) {\r\n\t\treturn \"null\";\r\n\t}\r\n\tif(s.length >= 5) {\r\n\t\treturn \"<...>\";\r\n\t}\r\n\tvar t = typeof(o);\r\n\tif(t == \"function\" && (o.__name__ || o.__ename__)) {\r\n\t\tt = \"object\";\r\n\t}\r\n\tswitch(t) {\r\n\tcase \"function\":\r\n\t\treturn \"<function>\";\r\n\tcase \"object\":\r\n\t\tif(((o) instanceof Array)) {\r\n\t\t\tvar str = \"[\";\r\n\t\t\ts += \"\\t\";\r\n\t\t\tvar _g = 0;\r\n\t\t\tvar _g1 = o.length;\r\n\t\t\twhile(_g < _g1) {\r\n\t\t\t\tvar i = _g++;\r\n\t\t\t\tstr += (i > 0 ? \",\" : \"\") + js_Boot.__string_rec(o[i],s);\r\n\t\t\t}\r\n\t\t\tstr += \"]\";\r\n\t\t\treturn str;\r\n\t\t}\r\n\t\tvar tostr;\r\n\t\ttry {\r\n\t\t\ttostr = o.toString;\r\n\t\t} catch( _g ) {\r\n\t\t\treturn \"???\";\r\n\t\t}\r\n\t\tif(tostr != null && tostr != Object.toString && typeof(tostr) == \"function\") {\r\n\t\t\tvar s2 = o.toString();\r\n\t\t\tif(s2 != \"[object Object]\") {\r\n\t\t\t\treturn s2;\r\n\t\t\t}\r\n\t\t}\r\n\t\tvar str = \"{\\n\";\r\n\t\ts += \"\\t\";\r\n\t\tvar hasp = o.hasOwnProperty != null;\r\n\t\tvar k = null;\r\n\t\tfor( k in o ) {\r\n\t\tif(hasp && !o.hasOwnProperty(k)) {\r\n\t\t\tcontinue;\r\n\t\t}\r\n\t\tif(k == \"prototype\" || k == \"__class__\" || k == \"__super__\" || k == \"__interfaces__\" || k == \"__properties__\") {\r\n\t\t\tcontinue;\r\n\t\t}\r\n\t\tif(str.length != 2) {\r\n\t\t\tstr += \", \\n\";\r\n\t\t}\r\n\t\tstr += s + k + \" : \" + js_Boot.__string_rec(o[k],s);\r\n\t\t}\r\n\t\ts = s.substring(1);\r\n\t\tstr += \"\\n\" + s + \"}\";\r\n\t\treturn str;\r\n\tcase \"string\":\r\n\t\treturn o;\r\n\tdefault:\r\n\t\treturn String(o);\r\n\t}\r\n};\r\nvar $_;\r\nfunction $bind(o,m) { if( m == null ) return null; if( m.__id__ == null ) m.__id__ = $global.$haxeUID++; var f; if( o.hx__closures__ == null ) o.hx__closures__ = {}; else f = o.hx__closures__[m.__id__]; if( f == null ) { f = m.bind(o); o.hx__closures__[m.__id__] = f; } return f; }\r\n$global.$haxeUID |= 0;\r\nif(typeof(performance) != \"undefined\" ? typeof(performance.now) == \"function\" : false) {\r\n\tHxOverrides.now = performance.now.bind(performance);\r\n}\r\nString.__name__ = true;\r\nArray.__name__ = true;\r\njs_Boot.__toStr = ({ }).toString;\r\nLibrary.LF = \"\\n\";\r\nLibrary.EMPTY = \"\";\r\nLibrary.SPACE = \" \";\r\nLibrary.COLON = \"::\";\r\nLibrary.LINE = \"|\";\r\nLibrary.ITEM = \"::\";\r\nLibrary.COMA = \",\";\r\nLibrary.DASH = \"-\";\r\nLibrary.KEY = \":\";\r\nLibrary.parseSpeaker = true;\r\nLibrary.TYPE = 0;\r\nLibrary.TEXT = 1;\r\nLibrary.DATA = 2;\r\nLibrary.PROP = 3;\r\nLogic.random = new Random();\r\nStorage.variable = new haxe_ds_StringMap();\r\nApp.main();\r\n})(typeof exports != \"undefined\" ? exports : typeof window != \"undefined\" ? window : typeof self != \"undefined\" ? self : this, typeof window != \"undefined\" ? window : typeof global != \"undefined\" ? global : typeof self != \"undefined\" ? self : this);\r\n\t</script>\r\n</html>",
 	editorExtensions: {
		twine: {
			'^2.4.0-alpha1': {
				codeMirror: {
					commands: {
						insertMove(editor) {
							editor.replaceSelection('[move route]');
							editor.focus();
						},
						insertLoad(editor) {
							editor.replaceSelection('[story name]');
							editor.focus();
						},
						insertTransition(editor) {
							editor.replaceSelection('[transition]');
							editor.focus();
						},
						insertWait(editor) {
							editor.replaceSelection('[wait time]');
							editor.focus();
						},
						insertClose(editor) {
							editor.replaceSelection('[close]');
							editor.focus();
						},
						insertLock(editor) {
							editor.replaceSelection('[lock]');
							editor.focus();
						},
						insertIf(editor) {
							editor.replaceSelection('[if condition]\n\n[end]');
							editor.focus();
						},
						insertIfElse(editor) {
							editor.replaceSelection('[if condition]\n\n[else]\n\n[end]');
							editor.focus();
						},
						insertVariable(editor) {
							editor.replaceSelection('[name = value]');
							editor.focus();
						},
						insertChance(editor) {
							editor.replaceSelection('[name chance value]');
							editor.focus();
						},
						insertDice(editor) {
							editor.replaceSelection('[name roll value]');
							editor.focus();
						},
						insertBrackets(editor) {
							editor.replaceSelection('[' + editor.getSelections() + ']');
							editor.focus();
						}
					},
					toolbar(editor, environment) {
						const iconColor = environment.appTheme === 'dark' ? 'hsl(0, 0%, 70%)' : 'hsl(0, 0%, 30%)';
						return [
							{
								type: 'menu',
								icon: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='${iconColor}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='icon icon-tabler icons-tabler-outline icon-tabler-sticker-2'%3E%3Cpath stroke='none' d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M6 4h12a2 2 0 0 1 2 2v7h-5a2 2 0 0 0 -2 2v5h-7a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2z' /%3E%3Cpath d='M20 13v.172a2 2 0 0 1 -.586 1.414l-4.828 4.828a2 2 0 0 1 -1.414 .586h-.172' /%3E%3C/svg%3E`,
								label: 'Story',
								items: [
									{
										type: 'button',
										command: 'insertMove',
										label: 'Move to route'
									},
									{
										type: 'button',
										command: 'insertLoad',
										label: 'Load story'
									},
									{type: 'separator'},
									{
										type: 'button',
										command: 'insertTransition',
										label: 'Transition'
									},
									{
										type: 'button',
										command: 'insertWait',
										label: 'Wait'
									},
									{type: 'separator'},
									{
										type: 'button',
										command: 'insertClose',
										label: 'Close'
									},
									{
										type: 'button',
										command: 'insertLock',
										label: 'Lock'
									}
								]
							},
							{
								type: 'menu',
								icon: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='${iconColor}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='icon icon-tabler icons-tabler-outline icon-tabler-edit'%3E%3Cpath stroke='none' d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M7 7h-1a2 2 0 0 0 -2 2v9a2 2 0 0 0 2 2h9a2 2 0 0 0 2 -2v-1' /%3E%3Cpath d='M20.385 6.585a2.1 2.1 0 0 0 -2.97 -2.97l-8.415 8.385v3h3l8.385 -8.415z' /%3E%3Cpath d='M16 5l3 3' /%3E%3C/svg%3E`,
								label: 'Modifiers',
								items: [
									{
										type: 'button',
										command: 'insertIf',
										label: 'If'
									},
									{
										type: 'button',
										command: 'insertIfElse',
										label: 'If and Else'
									},
									{type: 'separator'},
									{
										type: 'button',
										command: 'insertVariable',
										label: 'Variable'
									},
									{
										type: 'button',
										command: 'insertChance',
										label: 'Chance'
									},
									{
										type: 'button',
										command: 'insertDice',
										label: 'Dice'
									}
								]
							},
							{
								type: 'button',
								icon: `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='${iconColor}' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' class='icon icon-tabler icons-tabler-outline icon-tabler-brackets'%3E%3Cpath stroke='none' d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M8 4h-3v16h3' /%3E%3Cpath d='M16 4h3v16h-3' /%3E%3C/svg%3E`,
								label: 'Brackets',
								command: 'insertBrackets',
								disabled: !editor.getDoc().somethingSelected()
							}
						];
					},
					mode() {
						return {
							startState() {
								return {choice: false};
							},
							token(stream, state) {
								if (stream.eatSpace()) return null;

								if (stream.match('//')) {
								  stream.skipToEnd();
								  return 'meta';
								}

								if (stream.match('-')) {
									if (stream.skipTo(':')) {
										choice = true;
									}
									else {
										choice = false;
										stream.skipToEnd();
									}
									return 'text';
								}
								if (stream.match(':')) {
									if (choice) {
										stream.skipToEnd();
										choice = false;
										return 'keyword';
									}
									else {
										stream.skipToEnd();
									}
									return 'text';
								}
							
								if (stream.match(/^\[.+?\]/)) {
									return 'keyword';
								}
							
								stream.next();
								return 'text';
							}
						};
					}
				},
				references: {
					parsePassageText(text) {
						const matchers = [/\[move\s*(.+?)\s*]/g, /^-[^:\n]*:\s*([^\n:]*)(?=\s*:|\n|$)/gm];
						const results = [];

						for (const matcher of matchers) {
							let match;
							while ((match = matcher.exec(text))) {
								const action = match[1].match(/(=|\+|-|\*|\/| is | roll | chance )/);
								if (!action) {
									results.push(match[1].trim());
								}
							}
						}
						return results;
					}
				}
			}
		}
	}
});